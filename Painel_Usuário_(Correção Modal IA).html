<!-- Créditos:

Desenvolvido e Pensado por: João Vitor Correia
Produto: Mockup Creator (Alpha v1.0.0)
Implementador: João Vitor Correia
Licença: Temporária
Linkedin:https://www.linkedin.com/in/joão-vitor-correia-37b9a4176/
Data de última atualização do código: 28/05/2025 -->


<!-- WRAPPER da interface -->
<div class="interface-wrapper" style="position:relative;width:1420px;height:860px;margin:0 auto;">
  <!-- Loading overlay DENTRO do wrapper -->
  <div id="custom-loading-overlay" style="
    position:absolute;top:0;left:0;width:1430px;height:900px;border-radius:30PX;
    z-index:999;background:linear-gradient(135deg,#f9ebc7 40%,#b99470 100%);
    display:flex;align-items:center;justify-content:center;transition:opacity 0.7s cubic-bezier(.5,.01,.34,1);
    box-shadow:0 8px 64px #783d1918;overflow:hidden;">
    <div id="custom-loading-inner" style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:28px;">
      <img src="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/Sem_nome_250_x_250_px.png?v=1747315608" alt="Logo" style="width:250px;height:150px;animation:logo-bounce 1.8s cubic-bezier(.39,.75,.56,1.52) infinite;">
      <div style="margin-top:10px;font-size:1.12rem;color:#783D19;letter-spacing:1.4px;font-weight:bold;">Carregando interface...</div>
      <div class="loading-bar-anim" style="width:130px;height:7px;border-radius:8px;background:#fff2;overflow:hidden;position:relative;">
        <div id="custom-bar-load" style="width:0;height:100%;background:linear-gradient(90deg,#783D19 0%,#B99470 100%);border-radius:8px;transition:width 3.2s cubic-bezier(.6,0,.79,1.08);"></div>
      </div>
    </div>
  </div>

  <div class="produto-pagina-remasterizada" style="border-radius: 30px;">

    <!-- Painel lateral esquerdo: ferramentas -->
    <aside class="painel-lateral-remaster" style="border-radius: 30px;">
      <div class="tools-group">
        <div class="tool-block">
            <div class="codigo-estampa-remaster" id="codigoEstampa">
            Código da Estampa
            </div>
          <div class="tool-label">Zoom</div>
              <div class="zoom-controls">
              <button class="circle-btn" id="zoomIn" type="button" aria-label="Aumentar zoom">+</button>
              <div class="zoom-slider-wrapper">
                  <input type="range" id="zoomSlider" min="90" max="400" value="100" step="1" orient="vertical" class="zoom-slider-vertical">
              </div>
              <button class="circle-btn" id="zoomOut" type="button" aria-label="Diminuir zoom">-</button>
              </div>
        </div>
        <div class="tool-block">
          <div class="tool-label">Mover Estampa</div>
          <div class="joystick-area">
            <div id="joystickBase" class="joystick-base">
              <div id="joystickHandle" class="joystick-handle"></div>
            </div>
          </div>
        </div>
      </div>
        <!-- Botão "Abrir IA" adicionado aqui -->
      <button id="abrirIaBtn" class="btn-primary ia" type="button">
        🤖 Dúvidas
      </button>
      <button id="showConfig" class="btn-primary info-btn" type="button">
        ⚙️ Copiar Config.
      </button>
      <button id="uploadButton" class="btn-upload-remaster" type="button">
        ⬆️ Enviar Imagem
      </button>
      <!-- Adicionado botão "Falar com representante" aqui -->
      <button id="falarRepresentanteBtn" class="btn-primary" type="button" style="width:100%;margin-top:18px;background:#25D366;color:#fff;display:flex;align-items:center;gap:8px;justify-content:center;font-size:1.08rem;">
        <img src="https://cdn-icons-png.flaticon.com/512/733/733585.png" alt="WhatsApp" style="width:22px;height:22px;vertical-align:middle;margin-right:7px;"> Falar com representante
      </button>
    </aside>

    <!-- Centro: mockup e overlay -->
    <main class="center-mockup">
      <div class="mockup-content" style="position:relative;">
        <!-- BOX DINÂMICO DE REFERÊNCIA DE CM -->
        <div class="ref-cm-box" id="refCmBox" style="display:none;">
          <span id="refCmNome"></span>
          <span id="refCmValue"></span>
        </div>
        <!-- FIM REF-CM-BOX -->
        <div class="estampa-bg" id="estampaBg"></div>
        <img src="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/mockup_experimental_1.png?v=1746646882" class="mockup-png" />
      </div>
    </main>

    <!-- Painel lateral direito: categorias e upload -->
    <aside class="painel-lateral-categorias" style="border-radius: 30px;">
      <div class="tabs-categorias">
        <button class="tab-btn-remaster active" id="tabMockupsBtn" type="button">
          🧢 Mockups
        </button>
        <button class="tab-btn-remaster" id="tabEstampasBtn" type="button">
        🖼️ Estampas
        </button>
        <button class="tab-btn-remaster" id="tabTecidosBtn" type="button">
        🧵 Tecidos
        </button>
      </div>
      <div id="compartimentosMockup" class="compartimentos-categorias-remaster">
        <div class="categoria-box-remaster">
          <div class="categoria-title-remaster">👗 Vestidos</div>
          <div class="categoria-thumbnails-remaster">
            <div class="thumbnail" data-url="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/1_f1889a02-1ccc-4139-b9e5-5651a4f86f86.png?v=1747078489" data-type="preset" data-name="Vestido 01"><img src="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/1_f1889a02-1ccc-4139-b9e5-5651a4f86f86.png?v=1747078489" class="mockup-circle" /></div>
            <div class="thumbnail" data-url="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/3_bc04240f-3214-40c4-8c4e-060485f8368e.png?v=1747078489" data-type="preset" data-name="Vestido 02"><img src="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/3_bc04240f-3214-40c4-8c4e-060485f8368e.png?v=1747078489" class="mockup-circle" /></div>
          </div>
        </div>
        <div class="categoria-box-remaster">
          <div class="categoria-title-remaster">👕 Camisetas</div>
          <div class="categoria-thumbnails-remaster">
          </div>
        </div>
        <div class="categoria-box-remaster">
          <div class="categoria-title-remaster">🛋️ Estofados</div>
          <div class="categoria-thumbnails-remaster">
          <div class="thumbnail" data-url="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/2_9ead9243-af01-40a9-84c4-3cc56dc690be.png?v=1747078489" data-type="preset" data-name="Almofada 01"><img src="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/2_9ead9243-af01-40a9-84c4-3cc56dc690be.png?v=1747078489" class="mockup-circle" /></div>
          </div>
        </div>
      </div>
      <div id="compartimentosEstampa" class="compartimentos-categorias-remaster" style="display:none;">
        <div class="categoria-box-remaster">
          <div class="categoria-title-remaster">🔷 Geométrica</div>
          <div class="categoria-thumbnails-remaster">
            <div class="thumbnail" data-url="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/Design_sem_nome_3_0eb77a8a-9243-4d31-9e03-4546cc40b529.jpg?v=1747248867" data-code="Código: 23413 " data-type="preset" data-name="Estampa Geométrica 01" data-refcm="4" data-refnome="Flor central" style="background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/Design_sem_nome_3_0eb77a8a-9243-4d31-9e03-4546cc40b529.jpg?v=1747248867');" class="estampa-circle"></div>
          </div>
        </div>
        <div class="categoria-box-remaster">
          <div class="categoria-title-remaster">🌸 Floral</div>
          <div class="categoria-thumbnails-remaster">
            <div class="thumbnail" data-url="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/0093.jpg?v=1746645874" data-code="Código: 0093" data-type="preset" data-name="Estampa Floral 01" data-refcm="5.2" data-refnome="Folha maior" style="background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/0093.jpg?v=1746645874');" class="estampa-circle"></div>
            <div class="thumbnail" data-url="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/130570BB.jpg?v=1746711245" data-code="Código: 130570BB" data-type="preset" data-name="Estampa Floral 02" data-refcm="3.5" data-refnome="Flor roxa" style="background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/130570BB.jpg?v=1746711245');" class="estampa-circle"></div>
            <div class="thumbnail" data-url="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/0091.jpg?v=1746645874" data-code="Código: 0091" data-type="preset" data-name="Estampa Floral 03" data-refcm="6" data-refnome="Folha azul" style="background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/0091.jpg?v=1746645874');" class="estampa-circle"></div>
          </div>
        </div>
        <div class="categoria-box-remaster">
          <div class="categoria-title-remaster">🌴 Tropical</div>
          <div class="categoria-thumbnails-remaster">
            <div class="thumbnail" data-url="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/52678_ALT_FE_SP.jpg?v=1746645874" data-code="Código: 52678 ALT FE SP" data-type="preset" data-name="Estampa Tropical 01" data-refcm="40" data-refnome="Onça Inteira" style="background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/52678_ALT_FE_SP.jpg?v=1746645874');" class="estampa-circle"></div>
          </div>
        </div>
      </div>
      <div id="compartimentosTecidos" class="compartimentos-categorias-remaster" style="display:none;">
        <div class="categoria-box-remaster">
          <div class="categoria-title-remaster">Algodão</div>
          <div class="categoria-thumbnails-remaster">
            <div class="thumbnail tecido-thumbnail" data-nome="Algodão 100%" data-id="tecido-algodao-100" style="background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/algodao.jpg?v=1747259999');"></div>
            <div class="thumbnail tecido-thumbnail" data-nome="Algodão Egípcio" data-id="tecido-algodao-egipcio" style="background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/algodao-egipcio.jpg?v=1747259999');"></div>
          </div>
        </div>
        <div class="categoria-box-remaster">
          <div class="categoria-title-remaster">Poliéster</div>
          <div class="categoria-thumbnails-remaster">
            <div class="thumbnail tecido-thumbnail" data-nome="Poliéster Premium" data-id="tecido-poliester-premium" style="background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/poliester.jpg?v=1747259999');"></div>
          </div>
        </div>
        <div class="categoria-box-remaster">
          <div class="categoria-title-remaster">Linho</div>
          <div class="categoria-thumbnails-remaster">
            <div class="thumbnail tecido-thumbnail" data-nome="Linho Natural" data-id="tecido-linho-natural" style="background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/linho.jpg?v=1747259999');"></div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Modal de Upload -->
  <div id="uploadModal" class="modal-upload-remaster" style="display:none;">
    <div class="modal-content-remaster animate-modal">
      <h3>Upload de Arquivos</h3>
      <div class="upload-dropzones">
        <div id="dropEstampa" class="drop-zone-remaster">
          <span>Arraste ou clique para enviar Estampa</span>
          <input type="file" id="uploadEstampaInput" accept="image/*" style="display: none;">
        </div>
        <div id="dropMockup" class="drop-zone-remaster">
          <span>Arraste ou clique para enviar Mockup</span>
          <input type="file" id="uploadMockupInput" accept="image/*" style="display: none;">
        </div>
      </div>
      <button id="closeUploadModal" class="btn-cancel-upload" type="button">
        Cancelar
      </button>
    </div>
  </div>

  <!-- Modal de Copiar Config -->
  <div id="configModal" class="modal-info-remaster" style="display:none;">
    <div class="modal-content-remaster animate-modal info-modal-large">
      <button id="closeConfigModal" class="close-x-modal" type="button"
        aria-label="Fechar"
        style="position:absolute;top:18px;right:18px;background:none;border:none;font-size:2rem;line-height:1;color:#b99470;cursor:pointer;z-index:10;">×</button>
      <h3>Configuração Técnica</h3>
      <div class="info-flex-row">
        <div class="miniaturas-info">
          <div class="miniatura-info-block">
            <span class="miniatura-label">Mockup</span>
            <div class="miniatura-thumb" id="miniaturaMockup"></div>
            <div class="miniatura-mockup-label" id="labelMockup"></div>
          </div>
          <div class="miniatura-info-block">
            <span class="miniatura-label">Estampa</span>
            <div class="miniatura-thumb" id="miniaturaEstampa"></div>
            <div class="miniatura-estampa-label" id="labelEstampa"></div>
          </div>
        </div>
        <div class="config-table-remaster" id="configTable"></div>
      </div>
      <pre id="configData" class="config-data-remaster" style="display:none;"></pre>
      <div class="modal-actions-row">
        <button onclick="copyConfig()" class="btn-secundary" type="button">Copiar JSON</button>
        <button onclick="downloadMockup()" class="btn-primary" type="button">Baixar Mockup</button>
        <button onclick="downloadInfo('pdf')" class="btn-primary" type="button">Baixar PDF</button>
        <button onclick="downloadInfo('img')" class="btn-primary" type="button">Baixar Imagem Info</button>
      </div>
      <button id="toggleConfigRaw" class="btn-toggle-raw" type="button">Ver JSON</button>
    </div>
  </div>

  <!-- Botão de Créditos -->
<button id="creditosBtn" style="position:fixed;bottom:18px;left:18px;z-index:9999;background:#fff2;border:1.5px solid #b99470;color:#783D19;font-size:0.93rem;padding:6px 14px;border-radius:14px;box-shadow:0 2px 8px #783d1910;cursor:pointer;opacity:0.7;transition:opacity 0.18s;" type="button">Créditos</button>
<!-- Modal de Créditos -->
<div id="creditosModal" style="display:none;position:fixed;z-index:10050;top:0;left:0;width:100vw;height:100vh;background:rgba(120,61,25,0.13);backdrop-filter:blur(1.5px);align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:18px;box-shadow:0 10px 40px #783d1916;padding:32px 32px 24px 32px;min-width:320px;max-width:96vw;width:370px;display:flex;flex-direction:column;align-items:center;position:relative;">
    <button id="closeCreditosModal" type="button" style="position:absolute;top:14px;right:14px;background:none;border:none;font-size:1.7rem;color:#b99470;cursor:pointer;">×</button>
    <h3 style="margin-bottom:18px;color:#783D19;font-size:1.18rem;">Créditos</h3>
    <div style="font-size:1.04rem;color:#5F6F52;margin-bottom:10px;text-align:center;">Pensado e desenvolvido por:<br><b>João Vitor Correia</b></div>
    <div style="font-size:0.99rem;color:#783D19;margin-bottom:6px;">Código independente</div>
    <div style="font-size:0.99rem;color:#783D19;margin-bottom:6px;">© 2025 Direitos autorais de João Vitor Correia.</div>
    <div style="font-size:0.99rem;color:#783D19;margin-bottom:16px;">Versão 1.0</div>
    <a href="https://www.linkedin.com/in/joão-vitor-correia-37b9a4176/" target="_blank" rel="noopener" style="display:inline-block;margin-top:6px;text-decoration:none;">
      <button type="button" style="background:#0a66c2;color:#fff;border:none;border-radius:8px;padding:8px 18px;font-size:1.01rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:7px;">
        <img src="https://cdn-icons-png.flaticon.com/512/174/174857.png" alt="LinkedIn" style="width:20px;height:20px;vertical-align:middle;"> LinkedIn
      </button>
    </a>
  </div>
</div>

<style>
:root {
  --cor-primaria: #783D19;
  --cor-secundaria: #F9EBC7;
  --cor-terciaria: #B99470;
  --cor-quaternaria: #5F6F52;
  --cor-background: #F9EBC7;
  --cor-fundo-cards: #fff;
  --cor-borda: #B99470;
  --cor-hover: #5F6F52;
  --cor-branco: #fff;
  --cor-sombra: rgba(120,61,25,0.13);
  --cor-icone: #783D19;
  --cor-btn: linear-gradient(90deg, #783D19 0%, #B99470 100%);
  --cor-btn-hover: linear-gradient(90deg, #5F6F52 0%, #783D19 100%);
}


/* Caixa referência de cm dinâmico */
.ref-cm-box {
  position: absolute;
  left: 30px;
  top: 30px;
  background: #fff9;
  color: #783D19;
  border: 2px solid #b99470;
  border-radius: 10px;
  font-size: 1.04rem;
  font-weight: bold;
  padding: 7px 15px;
  box-shadow: 0 2px 10px #783d1922;
  z-index: 10;
  display: flex;
  align-items: center;
  gap: 7px;
  pointer-events: none;
}
.ref-cm-box span#refCmNome {
  font-weight: bold;
  font-size: 1.02rem;
  color: #5F6F52;
  margin-right: 10px;
}
.ref-cm-box span#refCmValue {
  color: #783D19;
  font-family: 'JetBrains Mono', 'Fira Mono', 'Menlo', monospace;
  font-size: 1.08rem;
  font-weight: bold;
}

@keyframes logo-bounce {
  0%   { transform: scale(1) rotate(-6deg);}
  13%  { transform: scale(1.13) rotate(3deg);}
  19%  { transform: scale(1.07) rotate(-2deg);}
  22%  { transform: scale(1.11) rotate(2deg);}
  33%  { transform: scale(1) rotate(-6deg);}
  100% { transform: scale(1) rotate(-6deg);}
}
@keyframes bar-shimmer {
  0% { background-position: -100px 0;}
  100% { background-position: 140px 0;}
}

.loading-bar-anim {
  background: #e7d7b7;
  box-shadow: 0 1px 5px #b9947030;
  position: relative;
  overflow: hidden;
}
.loading-bar-anim:after {
  content: '';
  position: absolute;
  left: 0; top: 0; width: 100%; height: 100%;
  background: linear-gradient(90deg,transparent 0%,#fff9 30%,#fff0 60%);
  animation: bar-shimmer 2.8s linear infinite;
  pointer-events: none;
}

body, html {
  background: var(--cor-background);
  margin: 0;
  padding: 0;
  font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
  color: var(--cor-primaria);
}

.produto-pagina-remasterizada {
  display: flex;
  flex-direction: row;
  width: 100vw;
  height: 100vh;
  max-width: 1430px;
  max-height: 900px;
  margin: 0 auto;
  background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/Sem_nome_1920_x_1080_px_1920_x_600_px_1920_x_900_px_1920_x_1080_px_2000_x_1920_px_2.png?v=1747252245');
  background-size: cover; /* cobre todo o container */
  background-position: center center; /* sempre centralizada */
  background-repeat: no-repeat;
  background-attachment: scroll; /* ou fixed se quiser efeito parallax */
  overflow: hidden;
  position: relative;
  font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
  box-sizing: border-box;
}
@media (max-width: 1300px) {
  .produto-pagina-remasterizada {
    max-width: 100vw;
    max-height: 100vh;
    flex-wrap: wrap;
  }
  .painel-lateral-categorias,
  .painel-lateral-remaster {
    min-width: 170px;
    max-width: 190px;
    padding-left: 6px;
    padding-right: 6px;
  }
  .center-mockup .mockup-content {
    width: 90vw;
    max-width: 400px;
    height: 60vw;
    max-height: 400px;
  }
}
@media (max-width: 1000px) {
  .produto-pagina-remasterizada {
    flex-direction: column;
    max-width: 100vw;
    max-height: 100vh;
    align-items: center;
    overflow: auto;
    gap: 0 !important;
  }
  .painel-lateral-remaster,
  .painel-lateral-categorias {
    flex-direction: row;
    width: 100vw;
    min-width: unset;
    max-width: 100vw;
    border-radius: 0;
    justify-content: center;
    padding: 18px 0;
    box-shadow: none !important;
  }
  .center-mockup {
    width: 100vw;
    max-width: 100vw;
    align-items: center;
    justify-content: center;
    padding: 20px 2vw;
  }
  .center-mockup .mockup-content {
    width: 90vw;
    min-width: 0;
    max-width: 350px;
    height: 60vw;
    max-height: 350px;
  }
}

/* Painel lateral esquerdo */
.painel-lateral-remaster {
  width: 220px;
  min-width: 200px;
  background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/Sem_nome_1920_x_1080_px_1920_x_600_px_1920_x_900_px_1920_x_1080_px_2000_x_1920_px_3.png?v=1747252245');
  background-size: cover; /* cobre todo o container */
  background-position: center center; /* sempre centralizada */
  background-repeat: no-repeat;
  background-attachment: scroll; /* ou fixed se quiser efeito parallax */
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 36px;
  padding: 46px 18px 34px 18px;
  border-radius: 0 30px 30px 0;
  box-shadow: 2px 0 18px var(--cor-sombra);
}
.tools-group {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 46px;
}
.tool-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}
.tool-label {
  font-size: 1.08rem;
  font-weight: bold;
  color: var(--cor-secundaria);
  margin-bottom: 7px;
  letter-spacing: 1.2px;
}
.zoom-controls {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: center;
  position: relative;
}
.zoom-slider-wrapper {
  width: 38px;      /* igual ao botão */
  height: 120px;    /* altura da barra */
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  z-index: 0;
}
.circle-btn {
  background: var(--cor-secundaria);
  color: var(--cor-primaria);
  border: none;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  font-size: 1.55rem;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 1px 8px #0001;
  transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.23s cubic-bezier(.55,.06,.68,.19);
  will-change: transform, background, color, box-shadow;
}
.circle-btn:hover {
  background: var(--cor-terciaria);
  color: var(--cor-quaternaria);
  box-shadow: 0 4px 16px #0002;
}
.circle-btn:active {
  transform: scale(0.92);
}
.zoom-slider-vertical {
  /* Remove margin to avoid overflow */
  margin: 0;
  /* Centraliza absolutamente dentro do wrapper */
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%,-50%) rotate(-90deg);
  width: 120px;    /* vira a altura visual */
  height: 12px;
  accent-color: var(--cor-terciaria);
  z-index: 1;
  pointer-events: auto;
}
.joystick-area {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.joystick-base {
  width: 90px;
  height: 90px;
  border: 4px solid var(--cor-secundaria);
  background: var(--cor-terciaria);
  border-radius: 50%;
  position: relative;
  margin-top: 5px;
  box-shadow: 0 2px 8px #0001;
}
.joystick-handle {
  width: 32px;
  height: 32px;
  background: var(--cor-primaria);
  border-radius: 50%;
  position: absolute;
  top: 29px;
  left: 29px;
  cursor: grab;
  box-shadow: 0 2px 8px #0002;
  border: 2.5px solid var(--cor-branco);
}

/* Botões principais */
.btn-primary, .btn-secundary, .btn-upload-remaster {
  border: none;
  border-radius: 18px;
  font-size: 1.04rem;
  font-weight: 700;
  padding: 10px 22px;
  cursor: pointer;
  box-shadow: 0 2px 10px #0001;
  letter-spacing: 0.8px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
  transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.23s cubic-bezier(.55,.06,.68,.19);
  will-change: transform, background, color, box-shadow;
}
.btn-primary {
  background: var(--cor-btn);
  color: var(--cor-branco);
}
.btn-primary:hover {
  background: var(--cor-btn-hover);
}
.btn-primary:active {
  transform: scale(0.92);
}
.btn-secundary {
  background: var(--cor-branco);
  color: var(--cor-primaria);
  border: 2px solid var(--cor-btn);
}
.btn-secundary:hover {
  color: var(--cor-quaternaria);
  border: 2px solid var(--cor-quaternaria);
}
.btn-secundary:active {
  transform: scale(0.92);
}
.info-btn .icon-gear {
  width: 20px; height: 20px; display: inline-block; background: url('https://fonts.gstatic.com/s/i/materialicons/engineering/v16/24px.svg') no-repeat center/contain;
  filter: invert(17%) sepia(91%) saturate(1200%) hue-rotate(349deg) brightness(80%) contrast(97%);
}

/* Mockup central */
.center-mockup {
  flex: 1 1 0;
  min-width: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  position: relative;
  z-index: 1;
  padding: 50px 12px 40px 12px;
}
.codigo-estampa-remaster {
  font-size: 1.08rem;
  font-weight: bold;
  color: var(--cor-primaria);
  background: var(--cor-secundaria);
  padding: 10px 28px;
  border-radius: 14px;
  border: 2px solid var(--cor-terciaria);
  text-align: center;
  box-shadow: 0 2px 8px #0002;
  margin-bottom: 20px;
  min-width: 190px;
}
.mockup-content {
  position: relative;
  width: 700px;
  height: 800px;
  border-radius: 30px;
  border: 4px solid var(--cor-borda);
  background: var(--cor-fundo-cards);
  overflow: hidden;
  box-shadow: 0 8px 36px #783d1910;
  transition: box-shadow 0.2s;
}
.estampa-bg {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0; left: 0;
  background-repeat: no-repeat;
  background-position: 50% 50%;
  background-size: 100%;
  pointer-events: none;
  z-index: 1;
}
.mockup-png {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0; left: 0;
  object-fit: contain;
  z-index: 2;
  transition: box-shadow 0.18s;
}

/* Painel lateral direito */
.painel-lateral-categorias {
  width: 345px;
  min-width: 270px;
  background-image: url('https://cdn.shopify.com/s/files/1/0661/4574/6991/files/Sem_nome_1920_x_1080_px_1920_x_600_px_1920_x_900_px_1920_x_1080_px_2000_x_1920_px_4.png?v=1747252245');
  background-size: cover; /* cobre todo o container */
  background-position: center center; /* sempre centralizada */
  background-repeat: no-repeat;
  background-attachment: scroll; /* ou fixed se quiser efeito parallax */
  border-radius: 30px 0 0 30px;
  box-shadow: -2px 0 18px var(--cor-sombra);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  padding: 36px 22px 24px 28px;
  gap: 18px;
}
.tabs-categorias {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  justify-content: center;
  align-items: flex-end;
  gap: 0 8px;
  width: 100%;
  margin-bottom: 16px;
}
.tab-btn-remaster {
  font-size: 1.08rem;
  font-weight: 700;
  border: none;
  border-radius: 18px 18px 0 0;
  padding: 10px 18px;
  min-width: 90px;
  background: var(--cor-terciaria);
  color: var(--cor-primaria);
  cursor: pointer;
  transition: background 0.17s, color 0.16s, box-shadow 0.18s, transform 0.23s cubic-bezier(.55,.06,.68,.19);
  outline: none;
  margin-right: 0;
  margin-bottom: 0;
  box-shadow: 0 2px 8px #0001;
  letter-spacing: 1px;
  display: flex; align-items: center; gap: 8px;
  will-change: transform, background, color, box-shadow;
  flex: 1 1 0;
  justify-content: center;
  max-width: 120px;
}
@media (max-width: 600px) {
  .tabs-categorias {
    flex-direction: column;
    align-items: stretch;
    gap: 8px 0;
  }
  .tab-btn-remaster {
    min-width: 0;
    width: 100%;
    max-width: 100%;
    border-radius: 14px;
  }
}
.compartimentos-categorias-remaster {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 18px;
}
.categoria-box-remaster {
  background: var(--cor-secundaria);
  border-radius: 19px;
  padding: 14px 14px 12px 18px;
  box-shadow: 0 1px 8px #783d1910;
  margin-bottom: 0;
  transition: box-shadow 0.2s;
  border: 2px solid var(--cor-terciaria);
}
.categoria-box-remaster:hover {
  box-shadow: 0 4px 18px #783d1918;
}
.categoria-title-remaster {
  font-size: 1.02rem;
  font-weight: 600;
  color: var(--cor-primaria);
  margin-bottom: 10px;
  display: flex; align-items: center; gap: 7px;
  letter-spacing: 0.2px;
}
.categoria-thumbnails-remaster {
  display: flex;
  flex-direction: row;
  gap: 12px;
}
.thumbnail {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  overflow: hidden;
  background-size: cover;
  background-position: center;
  cursor: pointer;
  border: 3px solid var(--cor-terciaria);
  box-shadow: 0 2px 10px #783d1910;
  transition: transform 0.18s, border 0.18s, box-shadow 0.17s;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: var(--cor-branco);
}
.thumbnail:hover, .thumbnail.selected {
  transform: scale(1.14);
  border: 3px solid var(--cor-primaria);
  box-shadow: 0 6px 18px #783d192a;
  z-index: 2;
}
.mockup-circle, .estampa-circle {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
  background: #fff;
}
.estampa-circle {
  background-size: cover;
  background-position: center;
}
.btn-upload-remaster {
  width: 100%;
  margin-top: 20px;
  background: var(--cor-btn);
  color: var(--cor-branco);
  border-radius: 18px;
  font-size: 1.04rem;
  font-weight: 700;
  padding: 15px 0;
  box-shadow: 0 2px 10px #783d1922;
  cursor: pointer;
  letter-spacing: 1.1px;
  display: flex; align-items: center; justify-content: center; gap: 10px;
}
.btn-upload-remaster:hover {
  background: var(--cor-btn-hover);
  box-shadow: 0 6px 24px #5f6f5244;
}
.btn-upload-remaster:active {
  transform: scale(0.97);
}

/* Modal Upload e Info */
.modal-upload-remaster, .modal-info-remaster {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(120,61,25,0.08);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  animation: modalBackdrop 0.38s cubic-bezier(.3,.8,.32,1) both;
}
@keyframes modalBackdrop {
  0% { background: rgba(120,61,25,0); }
  100% { background: rgba(120,61,25,0.08);}
}
.modal-content-remaster {
  position: relative; 
  background: var(--cor-branco);
  border-radius: 18px;
  box-shadow: 0 10px 40px #783d1916;
  padding: 32px 32px 20px 32px;
  min-width: 340px;
  max-width: 98vw;
  width: 370px;
  display: flex;
  flex-direction: column;
  align-items: center;
  animation: modalOpen 0.36s cubic-bezier(.39,1.52,.37,.98);
}

.close-x-modal {
  position: absolute;
  top: 18px;
  right: 18px;
  background: none;
  border: none;
  font-size: 2rem;
  line-height: 1;
  color: #b99470;
  cursor: pointer;
  z-index: 10;
  transition: color 0.14s;
}
.close-x-modal:hover {
  color: #783D19;
}

@keyframes modalOpen {
  0% { opacity: 0; transform: translateY(40px) scale(0.95);}
  100% { opacity: 1; transform: translateY(0) scale(1);}
}
.info-modal-large {
  min-width: 600px;
  max-width: 780px;
  min-height: 350px;
  padding: 30px 32px 26px 32px;
}
.info-flex-row {
  display: flex;
  flex-direction: row;
  gap: 28px;
  width: 100%;
  justify-content: flex-start;
  align-items: flex-start;
}
.miniaturas-info {
  display: flex;
  flex-direction: column;
  gap: 12px;
  min-width: 160px;
  align-items: center;
  margin-top: 10px;
}
.miniatura-info-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
}
.miniatura-label {
  font-weight: bold;
  color: #783D19;
  font-size: 1.04rem;
  margin-bottom: 2px;
}
.miniatura-thumb {
  width: 80px;
  height: 80px;
  background: #f5e7d4 center/contain no-repeat;
  border-radius: 9px;
  border: 2px solid #b99470;
  margin-bottom: 2px;
  box-shadow: 0 2px 8px #b9947033;
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}
.miniatura-mockup-label,
.miniatura-estampa-label {
  font-size: 0.96rem;
  color: #5F6F52;
  margin-top: 0px;
  text-align: center;
  min-height: 24px;
}
@media (max-width: 800px) {
  .info-modal-large { min-width: 100vw; max-width: 100vw; }
  .info-flex-row { flex-direction: column; gap: 10px; }
  .miniaturas-info { flex-direction: row; gap: 18px; margin-bottom: 10px;}
}
.upload-dropzones {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 100%;
  margin: 18px 0 12px 0;
}
.drop-zone-remaster {
  border: 2.5px dashed var(--cor-primaria);
  border-radius: 12px;
  background: #f5e7d4;
  padding: 25px 15px;
  text-align: center;
  color: var(--cor-primaria);
  font-weight: bold;
  transition: border-color 0.2s, background 0.2s;
  cursor: pointer;
  position: relative;
  min-height: 70px;
  user-select: none;
  font-size: 1.01rem;
}
.drop-zone-remaster.dragover {
  border-color: var(--cor-quaternaria);
  background: #e0ffe0;
  color: var(--cor-quaternaria);
}
.drop-zone-remaster input[type="file"] {
  display: none;
}
.btn-cancel-upload {
  background: var(--cor-terciaria);
  color: var(--cor-primaria);
  border: none;
  border-radius: 12px;
  font-size: 1.01rem;
  font-weight: 600;
  margin-top: 16px;
  padding: 8px 26px;
  cursor: pointer;
  transition: background 0.18s, color 0.18s, transform 0.23s cubic-bezier(.55,.06,.68,.19);
}
.btn-cancel-upload:hover {
  background: var(--cor-primaria);
  color: var(--cor-secundaria);
}
.btn-cancel-upload:active {
  transform: scale(0.95);
}
.modal-actions-row {
  display: flex;
  flex-direction: row;
  gap: 10px;
  margin-top: 16px;
}
.config-table-remaster {
  width: 100%;
  border-radius: 10px;
  background: #FAF4EC;
  margin-bottom: 14px;
  padding: 14px 14px 10px 14px;
  font-size: 1.04rem;
  color: #5f6f52;
  font-family: 'Inter', Arial, sans-serif;
  box-shadow: 0 2px 7px #b9947030;
  display: grid;
  grid-template-columns: max-content 1fr;
  row-gap: 6px;
  column-gap: 18px;
  align-items: center;
  transition: all 0.23s;
}
.config-table-remaster .config-key {
  font-weight: 600;
  color: #783D19;
  text-align: right;
  letter-spacing: .03em;
}
.config-table-remaster .config-value {
  font-family: 'JetBrains Mono', 'Fira Mono', 'Courier', monospace;
  background: #f5e7d4;
  border-radius: 6px;
  padding: 2px 8px;
  color: #5f6f52;
  font-size: .98rem;
  word-break:break-all;
}
.btn-toggle-raw {
  margin-top: 10px;
  font-size: .96rem;
  border: none;
  background: #e0d7c1;
  color: #783D19;
  border-radius: 10px;
  padding: 7px 17px;
  cursor: pointer;
  transition: background 0.18s, color 0.18s;
}
.btn-toggle-raw:hover {
  background: #b99470;
  color: #fff;
}
.config-data-remaster {
  background: #f7e9d9;
  color: #783D19;
  border-radius: 7px;
  padding: 11px 10px;
  max-height: 180px;
  overflow-y: auto;
  width: 100%;
   font-size: 0.98rem;
  font-family: 'JetBrains Mono', 'Fira Mono', 'Menlo', monospace;
  margin-bottom: 8px;
  display: none;
}
::-webkit-scrollbar { width: 7px; background: #F9EBC7; border-radius: 20px;}
::-webkit-scrollbar-thumb { background: #B99470; border-radius: 20px;}

/* Icones SVG embutidos */
.icon-gear { width: 20px; height: 20px; display: inline-block; background: url('data:image/svg+xml;utf8,<svg fill="783D19" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="783D19" d="M19.43 12.98c.04-.32.07-.65.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46a.5.5 0 00-.6-.22l-2.49 1a7.027 7.027 0 00-1.69-.98l-.38-2.65A.488.488 0 0014 2h-4a.5.5 0 00-.5.42l-.38 2.65a7.027 7.027 0 00-1.69.98l-2.49-1a.5.5 0 00-.6.22l-2 3.46a.495.495 0 00.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65a.495.495 0 00-.12.64l2 3.46c.14.24.44.32.68.22l2.49-1c.52.38 1.08.71 1.69.98l.38 2.65A.5.5 0 0010 22h4c.25 0 .46-.18.5-.42l.38-2.65c.61-.27 1.17-.6 1.69-.98l2.49 1c.24.1.54.02.68-.22l2-3.46a.495.495 0 00-.12-.64l-2.11-1.65zM12 15.5A3.5 3.5 0 1112 8a3.5 3.5 0 010 7.5z"/></svg>') no-repeat center/contain;}


/* Deixe o botão "Enviar Imagem" (btn-upload-remaster) com as mesmas proporções do "Copiar Config." (btn-primary info-btn) */

/* Ambos os botões agora terão a mesma largura, altura, padding, fonte e aparência */
.btn-primary.info-btn,
.btn-upload-remaster, .btn-primary.ia {
  width: 100%;
  min-width: 0;
  max-width: 100%;
  background: var(--cor-btn);
  color: var(--cor-branco);
  border-radius: 18px;
  font-size: 1.04rem;
  font-weight: 700;
  padding: 15px 0;
  box-shadow: 0 2px 10px #783d1922;
  cursor: pointer;
  letter-spacing: 1.1px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

/* Hover & active iguais */
.btn-primary.info-btn:hover,
.btn-upload-remaster:hover {
  background: var(--cor-btn-hover);
  box-shadow: 0 6px 24px #5f6f5244;
}
.btn-primary.info-btn:active,
.btn-upload-remaster:active {
  transform: scale(0.97);
}

/* Remove margem duplicada caso as duas classes estejam próximas */
.btn-primary.info-btn + .btn-upload-remaster {
  margin-top: -10px;
}

.send-config-dialog-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: modalBackdrop 0.38s cubic-bezier(.3,.8,.32,1) both;
}
.send-config-dialog {
  background: #f9ebc7;
  border-radius: 18px;
  padding: 32px;
  box-shadow: 0 10px 40px #783d1916;
  display: flex;
  flex-direction: column;
  align-items: center;
  animation: modalOpen 0.36s cubic-bezier(.39,1.52,.37,.98);
  position: relative;
}
.send-config-dialog h3 {
  color: #783D19;
  margin-bottom: 24px;
  font-size: 1.2rem;
  text-align: center;
}
.send-config-dialog-btns {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 100%;
}
.send-config-dialog-btns button {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.18s, transform 0.23s cubic-bezier(.55,.06,.68,.19);
}
.send-config-dialog-btns button:hover {
  transform: translateY(-2px);
}
.send-config-dialog-btns button:active {
  transform: translateY(0);
}
.send-config-dialog-btns #sendConfigMail {
  background: #783D19;
  color: #fff;
}
.send-config-dialog-btns #sendConfigWhats {
  background: #25D366;
  color: #fff;
}
.send-config-dialog-btns #sendConfigCancel {
  background: #ccc;
  color: #333;
}

/* --- NOVO CSS PARA O MODAL DE ENVIO --- */
@keyframes modalBackdrop {
  0% { background: rgba(120,61,25,0); }

  100% { background: rgba(120,61,25,0.7);}
}
@keyframes modalOpen {
  0% { opacity: 0; transform: translateY(40px) scale(0.95);}
  100% { opacity: 1; transform: translateY(0) scale(1);}
}

.ia-copy-btn-row {
  display: flex;
  justify-content: flex-end;
  margin-top: 4px;
  pointer-events: none;
}
.ia-copy-btn {
  background: none;
  border: none;
  padding: 0;
  margin: 0 0 0 6px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.18s;
  pointer-events: auto;
  display: flex;
  align-items: center;
}
.ia-msg-row:hover .ia-copy-btn,
.ia-copy-btn:focus {
  opacity: 1;
}
.ia-copy-btn svg {
  display: block;
  stroke: #783D19;
  transition: stroke 0.18s;
}
.ia-copy-btn.copied svg {
  stroke: #5F6F52;
}

/* --- NOVO CSS PARA MARCA D'ÁGUA --- */
.watermark-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  opacity: 0.35;
  pointer-events: none;
  z-index: 1;
}

/* Reflexo animado para o botão IA */
.btn-primary.ia {
  position: relative;
  overflow: hidden;
  z-index: 1;
  border: 3px solid;
  border-image: linear-gradient(90deg, #783D19, #B99470, #F9EBC7, #5F6F52, #783D19) 1;
  border-radius: 30%;
  background: linear-gradient(90deg, #783D19 0%, #B99470 50%, #F9EBC7 100%);
  transition: background 0.5s, border 0.5s;
}

.btn-primary.ia::after {
  content: '';
  position: absolute;
  left: -60%;
  top: 0;
  width: 60%;
  height: 100%;
  background: linear-gradient(120deg, transparent 0%, #fff9 50%, transparent 100%);
  transform: skewX(-25deg);
  animation: ia-shimmer 2.2s infinite;
  pointer-events: none;
  z-index: 2;
}

@keyframes ia-shimmer {
  0% { left: -60%; }
  60% { left: 120%; }
  100% { left: 120%; }
}
/* --- FIM NOVO CSS --- */
</style>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
// Função para buscar estampas do backend Render.com
function fetchEstampasBackend(callback) {
  fetch('https://estampas-oda7.onrender.com/estampas', {
    headers: {
      'Authorization': 'Basic ' + btoa('admin:senha123') // Troque se mudar usuário/senha do backend
    }
  })
    .then(res => {
      if (!res.ok) throw new Error('Erro ao buscar estampas');
      return res.json();
    })
    .then(data => {
      if (typeof callback === 'function') callback(data);
    })
    .catch(err => {

      alert('Erro ao carregar estampas do servidor: ' + err.message);
    });
}

// ----------------- REGUA REAL & REFERÊNCIA DINÂMICA + MARCAÇÕES -----------------
window.refCm = 0; // Valor em cm da referência atual
window.refNome = ''; // Nome do elemento referência
window.refCmDefault = 4; // Valor padrão se não houver na estampa
window.refNomeDefault = "Elemento referência";

document.addEventListener('DOMContentLoaded', function () {
  // ----------- RÉGUA VISUAL (marcação de cm e metros) -----------
  const reguaMetros = document.querySelector('.regua-metros');
  if (reguaMetros && !reguaMetros.querySelector('.regua-tick')) {
    for (let i = 0; i <= 200; i++) {
      const tick = document.createElement('span');
      tick.className = 'regua-tick';
      // 800px = 2m => cada cm = 4px
      const y = i * 4;
      tick.style.top = `${y}px`;
      if (i % 100 === 0) {
        tick.classList.add('major');
      } else if (i % 50 === 0) {
        tick.classList.add('mid');
      }
      reguaMetros.appendChild(tick);
    }
  }

  // Box de referência dinâmica
  const refCmBox = document.getElementById('refCmBox');
  const refCmNomeSpan = document.getElementById('refCmNome');
  const refCmValue = document.getElementById('refCmValue');

  // Função para atualizar o box dinâmico de referência
  window.updateRefCmBox = function updateRefCmBox() {
    const zoomSlider = document.getElementById('zoomSlider');
    if (window.refCm > 0 && refCmBox && refCmValue && refCmNomeSpan && zoomSlider) {
      const mult = parseFloat(zoomSlider.value) / 100;
      const atual = +(window.refCm * mult).toFixed(2);
      refCmBox.style.display = 'flex';
      refCmNomeSpan.textContent = window.refNome ? window.refNome + ":" : window.refNomeDefault + ":";
      refCmValue.textContent = `${atual}cm`;
      refCmBox.title = `Com zoom de ${zoomSlider.value}%, o elemento de referência (${window.refCm}cm) fica com ${atual}cm`;
    } else if (refCmBox) {
      refCmBox.style.display = 'none';
    }
  };
});
</script>
<script>
function loadHtml2Canvas(callback) {
  if (window.html2canvas) return callback();
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
  script.onload = callback;
  document.body.appendChild(script);
}
loadHtml2Canvas(() => {
  document.addEventListener('DOMContentLoaded', function () {
    const estampaBg = document.getElementById('estampaBg');
    const zoomSlider = document.getElementById('zoomSlider');
    const codigoEstampa = document.getElementById('codigoEstampa');
    const mockupImg = document.querySelector('.mockup-png');
    const configModal = document.getElementById('configModal');
    const configData = document.getElementById('configData');
    const configTable = document.getElementById('configTable');
    const showConfigBtn = document.getElementById('showConfig');
    const uploadButton = document.getElementById('uploadButton');
    const uploadModal = document.getElementById('uploadModal');
    const closeUploadModal = document.getElementById('closeUploadModal');
    const closeConfigModal = document.getElementById('closeConfigModal');
    const toggleConfigRaw = document.getElementById('toggleConfigRaw');
    const uploadEstampaInput = document.getElementById('uploadEstampaInput');
    const uploadMockupInput = document.getElementById('uploadMockupInput');
    const dropEstampa = document.getElementById('dropEstampa');
    const dropMockup = document.getElementById('dropMockup');
    const miniaturaMockup = document.getElementById('miniaturaMockup');
    const miniaturaEstampa = document.getElementById('miniaturaEstampa');
    const labelMockup = document.getElementById('labelMockup');
    const labelEstampa = document.getElementById('labelEstampa');
    const refCmBox = document.getElementById('refCmBox');
    const refCmNomeSpan = document.getElementById('refCmNome');
    const refCmValue = document.getElementById('refCmValue');
    let posX = 50;
    let posY = 50;

    // Estado para saber se é personalizado ou preset
    window.mockupState = {type: "none", url: mockupImg.src, name: "", thumb: mockupImg.src};
    window.estampaState = {type: "none", url: "", code: "", name: ""};

    // Para identificar as pré-existentes
    const presetMockups = {};
    document.querySelectorAll('#compartimentosMockup .thumbnail').forEach(t => {
      presetMockups[t.getAttribute('data-url')] = {
        name: t.getAttribute('data-name') || 'Mockup pré-definido',
        thumb: t.querySelector('img') ? t.querySelector('img').src : t.getAttribute('data-url'),
      };
    });
    const presetEstampas = {};
    document.querySelectorAll('#compartimentosEstampa .thumbnail').forEach(t => {
      presetEstampas[t.getAttribute('data-url')] = {
        name: t.getAttribute('data-name') || 'Estampa pré-definida',
        thumb: t.style.backgroundImage ? t.style.backgroundImage.replace(/^url\(["']?/, '').replace(/["']?\)$/, '') : t.getAttribute('data-url'),
        code: t.getAttribute('data-code') || ''
      };
    });

    // ----------------- ZOOM SLIDER VERTICAL (cross-browser) -----------------
    zoomSlider.classList.add('zoom-slider-vertical');
    zoomSlider.style.writingMode = "bt-lr";

    // ----------------- ZOOM SLIDER CORREÇÃO -----------------
    function updateZoom(value) {
      zoomSlider.value = value;
      estampaBg.style.backgroundSize = `${value}%`;
      if (typeof window.updateRefCmBox === "function") window.updateRefCmBox();
    }
    zoomSlider.addEventListener('input', () => updateZoom(zoomSlider.value));

    // ----------------- CLIQUE CONTINUO NO ZOOM -----------------
    let zoomInterval = null;
    function zoomChange(direction) {
      let currentZoom = parseInt(zoomSlider.value, 10);
      let nextZoom = direction > 0 ? Math.min(currentZoom + 10, 400) : Math.max(currentZoom - 10, 90);
      if (nextZoom !== currentZoom) updateZoom(nextZoom);
    }
    function startZoomChange(direction) {
      zoomChange(direction);
      zoomInterval = setInterval(() => zoomChange(direction), 90);
    }
    function stopZoomChange() {
      clearInterval(zoomInterval);
      zoomInterval = null;
    }
    document.getElementById('zoomIn').addEventListener('mousedown', () => startZoomChange(1));
    document.getElementById('zoomOut').addEventListener('mousedown', () => startZoomChange(-1));
    document.getElementById('zoomIn').addEventListener('mouseup', stopZoomChange);
    document.getElementById('zoomOut').addEventListener('mouseup', stopZoomChange);
    document.getElementById('zoomIn').addEventListener('mouseleave', stopZoomChange);
    document.getElementById('zoomOut').addEventListener('mouseleave', stopZoomChange);
    document.getElementById('zoomIn').addEventListener('touchstart', (e) => { e.preventDefault(); startZoomChange(1); });
    document.getElementById('zoomOut').addEventListener('touchstart', (e) => { e.preventDefault(); startZoomChange(-1); });
    document.getElementById('zoomIn').addEventListener('touchend', stopZoomChange);
    document.getElementById('zoomOut').addEventListener('touchend', stopZoomChange);
    document.getElementById('zoomIn').addEventListener('click', (e) => { if (!zoomInterval) zoomChange(1); });
    document.getElementById('zoomOut').addEventListener('click', (e) => { if (!zoomInterval) zoomChange(-1); });

    (function(){
      setTimeout(() => {
        document.getElementById('custom-bar-load').style.width = "100%";
      }, 350);

      setTimeout(() => {
        const overlay = document.getElementById('custom-loading-overlay');
        if(overlay){
          overlay.style.opacity = 0;
          overlay.style.pointerEvents = "none";
          setTimeout(()=>{ overlay.style.display="none"; }, 800);
        }
      }, 7000);
    })();

    // --------- MODAL FLUIDO: abrir/fechar ---------
    showConfigBtn.addEventListener('click', () => {
      updateConfigModal();
      configModal.style.display = 'flex';
      setTimeout(() => configModal.querySelector('.modal-content-remaster').classList.add('animate-modal'), 1);
    });
    closeConfigModal.addEventListener('click', () => closeModal(configModal));
    function closeModal(modal) {
      const modalContent = modal.querySelector('.modal-content-remaster');
      modalContent.classList.remove('animate-modal');
      setTimeout(() => { modal.style.display = 'none'; }, 210);
    }
    configModal.addEventListener('mousedown', function(e){
      if (e.target === configModal) closeModal(configModal);
    });

    uploadButton.addEventListener('click', () => {
      uploadModal.style.display = 'flex';
      setTimeout(() => uploadModal.querySelector('.modal-content-remaster').classList.add('animate-modal'), 1);
    });
    closeUploadModal.addEventListener('click', () => closeModal(uploadModal));
    uploadModal.addEventListener('mousedown', function(e){
      if (e.target === uploadModal) closeModal(uploadModal);
    });

    // --------- MODAL INFORMAÇÕES TÉCNICAS INTUITIVO -----------
    function updateConfigModal() {
      miniaturaMockup.style.backgroundImage = window.mockupState.thumb ? `url('${window.mockupState.thumb}')` : 'none';
      miniaturaEstampa.style.backgroundImage = window.estampaState.thumb ? `url('${window.estampaState.thumb}')` : 'none';

      labelMockup.textContent = window.mockupState.type === "custom" ? "Mockup personalizado do cliente" : (window.mockupState.name || "Mockup");
      labelEstampa.textContent = window.estampaState.type === "custom" ? "Estampa personalizada pelo cliente" : (window.estampaState.name || "Estampa");

      const mult = parseFloat(zoomSlider.value) / 100;
      const refCmFinal = window.refCm > 0 ? +(window.refCm * mult).toFixed(2) : null;
      const config = {
        mockup: window.mockupState.url,
        estampa: window.estampaState.url,
        zoom: zoomSlider.value,
        posX: posX,
        posY: posY,
        codigo: codigoEstampa.textContent,
        elementoReferenciaNome: window.refNome || window.refNomeDefault,
        elementoReferenciaCm: window.refCm || null,
        elementoReferenciaCmFinal: refCmFinal
      };
      configData.textContent = JSON.stringify(config, null, 2);
      configTable.innerHTML = `
        <div class="config-key">Mockup</div>
        <div class="config-value"><span style="display:inline-block;max-width:170px;overflow:auto;">${escapeHtml(labelMockup.textContent)}</span></div>
        <div class="config-key">Estampa</div>
        <div class="config-value"><span style="display:inline-block;max-width:170px;overflow:auto;">${escapeHtml(labelEstampa.textContent)}</span></div>
        <div class="config-key">Zoom</div>
        <div class="config-value">${config.zoom}%</div>
        <div class="config-key">X</div>
        <div class="config-value">${config.posX}%</div>
        <div class="config-key">Y</div>
        <div class="config-value">${config.posY}%</div>
        <div class="config-key">Código</div>
        <div class="config-value">${escapeHtml(config.codigo)}</div>
        <div class="config-key">Elemento referência</div>
        <div class="config-value">${window.refNome || window.refNomeDefault}</div>
        <div class="config-key">Valor referência (cm)</div>
        <div class="config-value">${window.refCm || "-"}</div>
        <div class="config-key">Valor referência final (cm)</div>
        <div class="config-value">${refCmFinal !== null ? refCmFinal : "-"}</div>
      `;
      configData.style.display = 'none';
      toggleConfigRaw.innerText = 'Ver JSON';

      // Atualizar modal de config para mostrar tecido selecionado
      let tecidoInfo = '';
      if (tecidoSelecionado) {
        tecidoInfo = `<div class="config-key">Tecido</div><div class="config-value">${escapeHtml(tecidoSelecionado.nome)}</div>`;
      }
      configTable.innerHTML += tecidoInfo;
    }
    toggleConfigRaw.addEventListener('click', function(){
      if (configData.style.display === 'none') {
        configData.style.display = '';
        configTable.style.display = 'none';
        toggleConfigRaw.innerText = 'Ver Tabela';
      } else {
        configData.style.display = 'none';
        configTable.style.display = '';
        toggleConfigRaw.innerText = 'Ver JSON';
      }
    });

    window.copyConfig = function () {
      const text = configData.textContent;
      navigator.clipboard.writeText(text).then(() => {
        toggleConfigRaw.innerText = "Copiado!";
        setTimeout(()=>toggleConfigRaw.innerText='Ver JSON',900)
      }).catch(err => { console.error('Erro ao copiar: ', err); });
    };
    window.downloadMockup = function () {
      setTimeout(() => {
        html2canvas(document.querySelector('.mockup-content'), {
          useCORS: true, allowTaint: true, logging: false,
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = 'mockup-personalizado.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      }, 200);
    };

    // --- PDF e Imagem de Info Técnica
    window.downloadInfo = function(type) {
      const card = document.createElement('div');
      card.style.width = "600px";
      card.style.background = "#f9ebc7";
      card.style.padding = "30px";
      card.style.fontFamily = "Inter, Arial, sans-serif";
      card.style.borderRadius = "18px";
      card.style.color = "#5F6F52";
      card.style.boxShadow = "0 2px 12px #b9947040";
      const mult = parseFloat(zoomSlider.value) / 100;
      const refCmFinal = window.refCm > 0 ? +(window.refCm * mult).toFixed(2) : null;
      let tecidoHtml = '';
      if (typeof tecidoSelecionado !== 'undefined' && tecidoSelecionado && tecidoSelecionado.nome) {
        tecidoHtml = `<div><b>Tecido:</b> ${escapeHtml(tecidoSelecionado.nome)}</div>`;
      }
      card.innerHTML = `
        <div style="display:flex;flex-direction:row;gap:30px;">
          <div>
            <div style="font-weight:bold;color:#783D19;">Mockup</div>
            <div style="background:#fff;border-radius:9px;border:2px solid #b99470;width:80px;height:80px;box-shadow:0 2px 8px #b9947033;margin:6px auto  5px auto;display:flex;align-items:center;justify-content:center;">
              <img src="${window.mockupState.thumb || window.mockupState.url}" style="max-width:76px;max-height:76px;border-radius:7px;">
            </div>
            <div style="font-size:0.98rem;text-align:center;min-height:20px;margin-bottom:2px;">${escapeHtml(labelMockup.textContent)}</div>
          </div>
          <div>
            <div style="font-weight:bold;color:#783D19;">Estampa</div>
            <div style="background:#fff;border-radius:9px;border:2px solid #b99470;width:80px;height:80px;box-shadow:0 2px 8px #b9947033;margin:6px auto 5px auto;display:flex;align-items:center;justify-content:center;">
              <img src="${window.estampaState.thumb || window.estampaState.url}" style="max-width:76px;max-height:76px;border-radius:7px;">
            </div>
            <div style="font-size:0.98rem;text-align:center;min-height:20px;margin-bottom:2px;">${escapeHtml(labelEstampa.textContent)}</div>
          </div>
        </div>
        <div style="margin-top:18px;font-size:1.04rem;">
          <div><b>Zoom:</b> ${zoomSlider.value}%</div>
          <div><b>Posição X:</b> ${posX}%</div>
          <div><b>Posição Y:</b> ${posY}%</div>
          <div><b>Código:</b> ${escapeHtml(codigoEstampa.textContent)}</div>
          <div><b>Elemento referência:</b> ${window.refNome || window.refNomeDefault}</div>
          <div><b>Valor referência (cm):</b> ${window.refCm || "-"}</div>
          <div><b>Valor referência final (cm):</b> ${refCmFinal !== null ? refCmFinal : "-"}</div>
          ${tecidoHtml}
        </div>
      `;
      document.body.appendChild(card);
      if (type === 'img') {
        html2canvas(card, {useCORS:true,backgroundColor:null}).then(canvas => {
          const link = document.createElement('a');
          link.download = 'informacao_tecnica.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
          document.body.removeChild(card);
        });
      } else if (type === 'pdf') {
        html2canvas(card, {useCORS:true,backgroundColor:null}).then(canvas => {
          const doc = new window.jspdf.jsPDF({orientation:"p",unit:"px",format:[650,420]});
          const imgData = canvas.toDataURL("image/png");
          doc.addImage(imgData, "PNG", 20, 20, 560, 320);
          doc.save('informacao_tecnica.pdf');
          document.body.removeChild(card);
        });
      }
    };

    // ----------------- THUMBNAILS E TABS -----------------
    const tabMockupsBtn = document.getElementById('tabMockupsBtn');
    const tabEstampasBtn = document.getElementById('tabEstampasBtn');
    const tabTecidosBtn = document.getElementById('tabTecidosBtn');
    const compartimentosMockup = document.getElementById('compartimentosMockup');
    const compartimentosEstampa = document.getElementById('compartimentosEstampa');
    const compartimentosTecidos = document.getElementById('compartimentosTecidos');
    tabMockupsBtn.addEventListener('click', () => {
      tabMockupsBtn.classList.add('active');
      tabEstampasBtn.classList.remove('active');
      tabTecidosBtn.classList.remove('active');
      compartimentosMockup.style.display = "";
      compartimentosEstampa.style.display = "none";
      compartimentosTecidos.style.display = "none";
    });
    tabEstampasBtn.addEventListener('click', () => {
      tabEstampasBtn.classList.add('active');
      tabMockupsBtn.classList.remove('active');
      tabTecidosBtn.classList.remove('active');
      compartimentosMockup.style.display = "none";
      compartimentosEstampa.style.display = "";
      compartimentosTecidos.style.display = "none";
      // Atualiza as thumbnails de estampas sempre que a aba for ativada
      carregarEstampasPrincipais();
    });
    tabTecidosBtn.addEventListener('click', () => {
      tabTecidosBtn.classList.add('active');
      tabMockupsBtn.classList.remove('active');
      tabEstampasBtn.classList.remove('active');
      compartimentosMockup.style.display = "none";
      compartimentosEstampa.style.display = "none";
      compartimentosTecidos.style.display = "";
    });
    // Tecidos: seleção e estado
    let tecidoSelecionado = null;
    compartimentosTecidos.querySelectorAll('.tecido-thumbnail').forEach(thumbnail => {
      thumbnail.addEventListener('click', () => {
        compartimentosTecidos.querySelectorAll('.tecido-thumbnail.selected').forEach(el => el.classList.remove('selected'));
        thumbnail.classList.add('selected');
        tecidoSelecionado = {
          nome: thumbnail.getAttribute('data-nome'),
          id: thumbnail.getAttribute('data-id'),
          thumb: thumbnail.style.backgroundImage.replace(/^url\(["']?/, '').replace(/["']?\)$/, '')
        };
      });
    });

    // Drag and drop upload
    function handleEstampaFiles(files) {
      const arquivo = files[0];
      if (arquivo) {
        const reader = new FileReader();
        reader.onload = function(e) {
          estampaBg.style.backgroundImage = `url(${e.target.result})`;
          estampaBg.style.backgroundSize = `${zoomSlider.value}%`;
          estampaBg.style.backgroundPosition = `${posX}% ${posY}%`;
          window.estampaState = {
            type: "custom",
            url: e.target.result,
            code: "",
            name: "",
            thumb: e.target.result
          };
          window.refCm = window.refCmDefault;
          window.refNome = window.refNomeDefault;
          if (typeof window.updateRefCmBox === "function") window.updateRefCmBox();
        };
        reader.readAsDataURL(arquivo);
      }
      closeModal(uploadModal);
    }
    dropEstampa.addEventListener('click', () => uploadEstampaInput.click());
    dropEstampa.addEventListener('dragover', (e) => { e.preventDefault(); dropEstampa.classList.add('dragover'); });
    dropEstampa.addEventListener('dragleave', (e) => dropEstampa.classList.remove('dragover'));
    dropEstampa.addEventListener('drop', (e) => {
      e.preventDefault(); dropEstampa.classList.remove('dragover');
      if (e.dataTransfer.files.length) handleEstampaFiles(e.dataTransfer.files);
    });
    uploadEstampaInput.addEventListener('change', (event) => handleEstampaFiles(event.target.files));

    function handleMockupFiles(files) {
      const arquivo = files[0];
      if (arquivo) {
        const reader = new FileReader();
        reader.onload = function(e) {
          mockupImg.src = e.target.result;
          window.mockupState = {
            type: "custom",
            url: e.target.result,
            name: "",
            thumb: e.target.result
          };
        };
        reader.readAsDataURL(arquivo);
      }
      closeModal(uploadModal);
    }
    dropMockup.addEventListener('click', () => uploadMockupInput.click());
    dropMockup.addEventListener('dragover', (e) => { e.preventDefault(); dropMockup.classList.add('dragover'); });
    dropMockup.addEventListener('dragleave', (e) => dropMockup.classList.remove('dragover'));
    dropMockup.addEventListener('drop', (e) => {
      e.preventDefault(); dropMockup.classList.remove('dragover');
      if (e.dataTransfer.files.length) handleMockupFiles(e.dataTransfer.files);
    });
    uploadMockupInput.addEventListener('change', (event) => handleMockupFiles(event.target.files));

    // ----------------- JOYSTICK -----------------
    const joystickHandle = document.getElementById('joystickHandle');
    const joystickBase = document.getElementById('joystickBase');
    let isDragging = false;
    joystickHandle.addEventListener('mousedown', (e) => {
      isDragging = true;
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', () => {
        isDragging = false;
        joystickHandle.style.left = '29px';
        joystickHandle.style.top = '29px';
      }, { once: true });
    });
    function onDrag(e) {
      if (!isDragging) return;
      const rect = joystickBase.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const deltaX = e.clientX - centerX;
      const deltaY = e.clientY - centerY;
      let angleX = deltaX / (rect.width / 2);
      let angleY = deltaY / (rect.height / 2);
      angleX = Math.max(-1, Math.min(1, angleX));
      angleY = Math.max(-1, Math.min(1, angleY));
      posX += angleX * 2;
      posY += angleY * 2;
      posX = Math.max(0, Math.min(100, posX));
      posY = Math.max(0, Math.min(100, posY));
      estampaBg.style.backgroundPosition = `${posX}% ${posY}%`;
      joystickHandle.style.left = `${29 + angleX * 30}px`;
      joystickHandle.style.top = `${29 + angleY * 30}px`;
    }

    // Inicializa com padrão (primeira carga)
    window.refCm = window.refCmDefault;
    window.refNome = window.refNomeDefault;
    if (typeof window.updateRefCmBox === "function") window.updateRefCmBox();

    // Seleção de mockup
    document.querySelectorAll('#compartimentosMockup .thumbnail').forEach(thumbnail => {
      thumbnail.addEventListener('click', function() {
        document.querySelectorAll('#compartimentosMockup .thumbnail.selected').forEach(el => el.classList.remove('selected'));
        thumbnail.classList.add('selected');
        const url = thumbnail.getAttribute('data-url');
        const name = thumbnail.getAttribute('data-name') || 'Mockup';
        const thumb = thumbnail.querySelector('img') ? thumbnail.querySelector('img').src : url;
        mockupImg.src = url;
        window.mockupState = {
          type: 'preset',
          url: url,
          name: name,
          thumb: thumb
        };
        if (typeof updateConfigModal === 'function') updateConfigModal();
      });
    });
    // Seleção de estampa
    document.querySelectorAll('#compartimentosEstampa .thumbnail').forEach(thumbnail => {
      thumbnail.addEventListener('click', function() {
        document.querySelectorAll('#compartimentosEstampa .thumbnail.selected').forEach(el => el.classList.remove('selected'));
        thumbnail.classList.add('selected');
        const url = thumbnail.getAttribute('data-url');
        const name = thumbnail.getAttribute('data-name') || 'Estampa';
        const code = thumbnail.getAttribute('data-code') || '';
        const thumb = thumbnail.style.backgroundImage ? thumbnail.style.backgroundImage.replace(/^url\(["']?/, '').replace(/["']?\)$/, '') : url;
        estampaBg.style.backgroundImage = `url('${url}')`;
        estampaBg.style.backgroundSize = `${zoomSlider.value}%`;
        estampaBg.style.backgroundPosition = `${posX}% ${posY}%`;
        window.estampaState = {
          type: 'preset',
          url: url,
          code: code,
          name: name,
          thumb: thumb
        };
        // Atualiza código da estampa e referência se houver
        if (codigoEstampa) codigoEstampa.textContent = code || 'Código da Estampa';
        window.refCm = parseFloat(thumbnail.getAttribute('data-refcm')) || window.refCmDefault;
        window.refNome = thumbnail.getAttribute('data-refnome') || window.refNomeDefault;
        if (typeof window.updateRefCmBox === 'function') window.updateRefCmBox();
        if (typeof updateConfigModal === 'function') updateConfigModal();
      });
    });
  });
});

// Este script adiciona um botão "Enviar Configurações" ao modal de "Copiar Config".
// Permite ao usuário enviar a informação técnica (PDF ou imagem + mockup) para um e-mail ou WhatsApp pré-configurado.
// Requer html2canvas e jsPDF já carregados (como no código base).

// Configurações do destinatário
const EMAIL_DESTINO = "administrador@estudiodeestampamj.com";  // Troque para o e-mail desejado
const WHATSAPP_NUMERO = "5515991876055"; // Somente números com DDI/DDD. Exemplo: 5511999999999

document.addEventListener('DOMContentLoaded', function () {
  const sendConfigBtn = document.getElementById("sendConfigBtn");
  if (sendConfigBtn) {
    sendConfigBtn.onclick = showSendConfigDialog;
  }
});

// Abre um mini diálogo para escolher para onde enviar
function showSendConfigDialog() {
  // Evite abrir múltiplos
  if (document.getElementById('sendConfigDialog')) return;
  const dialog = document.createElement('div');
  dialog.id = 'sendConfigDialog';
  dialog.style.position = 'fixed';
  dialog.style.left = '0';
  dialog.style.right = '0';
  dialog.style.top = '0';
  dialog.style.bottom = '0';
  dialog.style.background = 'rgba(0,0,0,0.12)';
  dialog.style.zIndex = '99999';
  dialog.style.display = 'flex';
  dialog.style.alignItems = 'center';
  dialog.style.justifyContent = 'center';

  dialog.innerHTML = `
    <div style="background:#fff;border-radius:16px;box-shadow:0 8px 32px #0002;padding:33px 28px 18px 28px;display:flex;flex-direction:column;align-items:center;min-width:320px;">
      <h3 style="margin:0 0 15px 0;font-size:1.12rem;color:#783D19;">Enviar Configurações</h3>
      <div style="display:flex;flex-direction:column;gap:12px;width:100%;">
        <button id="sendConfigMail" class="btn-primary" style="width:100%;max-width:210px;">Enviar por E-mail</button>
        <button id="sendConfigWhats" class="btn-primary" style="width:100%;max-width:210px;">Enviar por WhatsApp</button>
        <button id="sendConfigCancel" class="btn-cancel-upload" style="margin-top:10px;width:100%;max-width:210px;">Cancelar</button>
      </div>
    </div>
  `;
  document.body.appendChild(dialog);

  document.getElementById('sendConfigMail').onclick = () => {
    dialog.remove();
    sendConfigVia('mail');
  };
  document.getElementById('sendConfigWhats').onclick = () => {
    dialog.remove();
    sendConfigVia('whatsapp');
  };
  document.getElementById('sendConfigCancel').onclick = () => dialog.remove();
}

// Função para capturar o card de informação técnica e enviar por e-mail/whatsapp
function sendConfigVia(destino) {
  // Montar o card visual igual ao PDF/IMG
  const modal = document.getElementById('configModal');
  if (!modal) return;

  // Copia do card visual igual ao downloadInfo()
  const mockupState = window.mockupState || getMockupState();
  const estampaState = window.estampaState || getEstampaState();
  const zoomSlider = document.getElementById('zoomSlider');
  const codigoEstampa = document.getElementById('codigoEstampa');
  let posX = 50, posY = 50;
  if (window.posX && window.posY) { posX = window.posX; posY = window.posY; }
  const labelMockup = document.getElementById('labelMockup');
  const labelEstampa = document.getElementById('labelEstampa');
  function escapeHtml(str) { return (str + '').replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

  const card = document.createElement('div');
  card.style.width = "600px";
  card.style.background = "#f9ebc7";
  card.style.padding = "30px";
  card.style.fontFamily = "Inter, Arial, sans-serif";
  card.style.borderRadius = "18px";
  card.style.color = "#5F6F52";
  card.style.boxShadow = "0 2px 12px #b9947040";
  card.innerHTML = `
      <div style='display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;'>
        <div style='font-weight:bold;color:#783D19;font-size:1.18rem;display:flex;align-items:center;gap:8px;'>${mockupState.name || ''}</div>
      </div>
      <div style='display:flex;gap:10px;margin-bottom:18px;'>
        <img src='${mockupState.thumb || mockupState.url}' style='flex:0 0 80px;height:80px;border-radius:7px;border:1.5px solid #b99470;object-fit:cover;'>
        <div style='flex:1;display:flex;flex-direction:column;gap:4px;'>
          <div style='font-weight:bold;color:#783D19;'>Mockup</div>
          <div style='font-size:0.98rem;text-align:center;min-height:20px;margin-bottom:2px;'>${escapeHtml(labelMockup.textContent)}</div>
        </div>
      </div>
      <div style='display:flex;gap:10px;margin-bottom:18px;'>
        <img src='${estampaState.thumb || estampaState.url}' style='flex:0 0 80px;height:80px;border-radius:7px;border:1.5px solid #b99470;object-fit:cover;'>
        <div style='flex:1;display:flex;flex-direction:column;gap:4px;'>
          <div style='font-weight:bold;color:#783D19;'>Estampa</div>
          <div style='font-size:0.98rem;text-align:center;min-height:20px;margin-bottom:2px;'>${escapeHtml(labelEstampa.textContent)}</div>
        </div>
      </div>
      <div style='font-size:1rem;color:#5F6F52;margin-bottom:12px;'>
        <div><b>Zoom:</b> ${zoomSlider.value}%</div>
        <div><b>Posição X:</b> ${posX}%</div>
        <div><b>Posição Y:</b> ${posY}%</div>
        <div><b>Código:</b> ${escapeHtml(codigoEstampa.textContent)}</div>
      </div>
  `;
  document.body.appendChild(card);

  // Gera imagem (png) do card
  window.html2canvas(card, {useCORS:true,backgroundColor:null}).then(canvas => {
    document.body.removeChild(card);
    if (destino === 'mail') {
      // Abre o cliente de e-mail com a imagem em attachment (ou link base64 se não suportar attachment direto)
      const subject = encodeURIComponent("Configuração Técnica do Produto");
      const body = encodeURIComponent("Segue em anexo a configuração técnica do mockup.\n\n");
      // Copia imagem para clipboard e informa o usuário para colar no e-mail se necessário
      canvas.toBlob(blob => {
        if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'configuracao.png', {type:blob.type})] })) {
          // Web Share API (Mobile/alguns desktop) - envia como attachment
          navigator.share({
            files: [new File([blob], 'configuracao.png', {type:blob.type})],
            title: 'Configuração Técnica',
            text: 'Segue a configuração técnica do mockup em anexo.'
          });
        } else {
          // Fallback: abre o mailto com subject/body e imagem em base64 + orienta usuário a colar a imagem
          const imageBase64 = canvas.toDataURL("image/png");
          const mailto = `mailto:${EMAIL_DESTINO}?subject=${subject}&body=${body}%0A%0A[Por favor, cole ou anexe a imagem gerada do mockup aqui:]`;
          window.open(mailto, "_blank");
          // Copia imagem para clipboard se possível
          if (navigator.clipboard && window.ClipboardItem) {
            blob.arrayBuffer().then(buffer => {
              const item = new window.ClipboardItem({ [blob.type]: blob });
              navigator.clipboard.write([item]).then(() => {
                alert("A imagem foi copiada para a área de transferência. Cole no corpo do e-mail.");
              });
            });
          } else {
            alert("A imagem foi gerada. Se possível, salve-a e anexe manualmente ao e-mail.");
            // Download automático como fallback
            const link = document.createElement('a');
            link.download = 'configuracao.png';
            link.href = imageBase64;
            link.click();
          }
        }
      }, 'image/png');
    } else if (destino === 'whatsapp') {
      // WhatsApp: não aceita upload direto de imagem. Usar link base64 ou instruir o usuário
      const imageBase64 = canvas.toDataURL("image/png");
      // Sugestão: subir para algum servidor e obter URL, ou instruir download/cópia
      // Aqui, envia o JSON e orienta o usuário a colar/baixar a imagem.
      const configData = document.getElementById('configData')?.textContent || '';
      const wppMsg = encodeURIComponent(
        "Configuração Técnica do Produto:\n\n" +
        "Mockup: " + (mockupState.name || "") + "\n" +
        "Estampa: " + (estampaState.name || "") + "\n" +
        "Zoom: " + (zoomSlider.value) + "%\n" +
        "Posição X: " + (posX) + "%\n" +
        "Posição Y: " + (posY) + "%\n" +
        "Código: " + (codigoEstampa.textContent) + "\n\n" +
        "Obs: A imagem técnica está em anexo ou foi baixada separadamente." +
        "\n\nJSON:\n" + configData
      );
      // Abre o WhatsApp Web (ou mobile)
      window.open(`https://wa.me/${WHATSAPP_NUMERO}?text=${wppMsg}`, "_blank");
      // Copia imagem para clipboard se possível
      if (navigator.clipboard && window.ClipboardItem) {
        canvas.toBlob(blob => {
          const item = new window.ClipboardItem({ [blob.type]: blob });
          navigator.clipboard.write([item]).then(() => {
            alert("A imagem técnica foi copiada para a área de transferência. Cole no WhatsApp.");
          });
        });
      } else {
        // Download como fallback
        const link = document.createElement('a');
        link.download = 'configuracao.png';
        link.href = imageBase64;
        link.click();
        alert("A imagem foi baixada. Envie manualmente no WhatsApp.");
      }
    }
  });
}

// Função global para abrir imagem grande (modal)
function abrirModalImagemGrande(src) {
  let modal = document.getElementById('iaImgModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'iaImgModal';
    modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.82);display:flex;align-items:center;justify-content:center;z-index:99999;';
    modal.innerHTML = `
      <div style="position:relative;display:flex;flex-direction:column;align-items:center;">
        <img id="iaImgModalImg" src="${src}" style="max-width:92vw;max-height:92vh;border-radius:18px;box-shadow:0 8px 40px #000b;">
        <div style="display:flex;gap:12px;position:absolute;top:18px;right:18px;">
          <button id="iaImgModalDownload" title="Baixar imagem" style="background:#fff;border:none;border-radius:50%;width:44px;height:44px;font-size:1.7rem;cursor:pointer;box-shadow:0 2px 8px #0004;display:flex;align-items:center;justify-content:center;">
            <svg width="26" height="26" fill="none" stroke="#783D19" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M12 5v14M5 12l7 7 7-7"/>
            </svg>
          </button>
          <button id="iaImgModalClose" title="Fechar" style="background:#fff;border:none;border-radius:50%;width:44px;height:44px;font-size:2rem;cursor:pointer;box-shadow:0 2px 8px #0004;display:flex;align-items:center;justify-content:center;">×</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('iaImgModalClose').onclick = () => modal.remove();
    document.getElementById('iaImgModalDownload').onclick = () => {
      const a = document.createElement('a');
      a.href = src;
      a.download = 'imagem-ia.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
  } else {
    document.getElementById('iaImgModalImg').src = src;
    modal.style.display = 'flex';
  }
}

// Função global para escapar HTML (usada no chat IA)
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

// Carregar estampas do backend e exibir na interface principal
function carregarEstampasPrincipais() {
  fetchEstampasBackend(function(json) {
    estampasJson = json;
    const compartimentosEstampa = document.getElementById('compartimentosEstampa');
    if (!compartimentosEstampa) return;
    // Remove todas as thumbnails fixas e antigas
    compartimentosEstampa.innerHTML = '';
    // Só exibe as dinâmicas do estampas.json
    estampasJson.categorias.forEach(cat => {
      const catDiv = document.createElement('div');
      catDiv.className = 'categoria-box-remaster';
      catDiv.innerHTML = `<div class="categoria-title-remaster">${cat.icone || ''} ${cat.nome}</div>`;
      const thumbsDiv = document.createElement('div');
      thumbsDiv.className = 'categoria-thumbnails-remaster';
      cat.estampas.forEach(est => {
        const thumb = document.createElement('div');
        thumb.className = 'thumbnail';
        thumb.setAttribute('data-url', est.url);
        thumb.setAttribute('data-code', est.code || '');
        thumb.setAttribute('data-type', 'preset');
        thumb.setAttribute('data-name', est.name || '');
        thumb.setAttribute('data-refcm', est.refcm || '');
        thumb.setAttribute('data-refnome', est.refnome || '');
        // Cria o <img> igual às mockups
        const img = document.createElement('img');
        img.src = est.url;
        img.className = 'estampa-circle';
        img.alt = est.name || 'Estampa';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '50%';
        thumb.appendChild(img);
        // Evento de clique
        thumb.addEventListener('click', function() {
          document.querySelectorAll('#compartimentosEstampa .thumbnail.selected').forEach(el => el.classList.remove('selected'));
          thumb.classList.add('selected');
          const url = thumb.getAttribute('data-url');
          const name = thumb.getAttribute('data-name') || 'Estampa';
          const code = thumb.getAttribute('data-code') || '';
          const refcm = parseFloat(thumb.getAttribute('data-refcm')) || window.refCmDefault;
          const refnome = thumb.getAttribute('data-refnome') || window.refNomeDefault;
          const estampaBg = document.getElementById('estampaBg');
          const zoomSlider = document.getElementById('zoomSlider');
          const codigoEstampa = document.getElementById('codigoEstampa');
          estampaBg.style.backgroundImage = `url('${url}')`;
          estampaBg.style.backgroundSize = `${zoomSlider.value}%`;
          estampaBg.style.backgroundPosition = `50% 50%`;
          window.estampaState = {
            type: 'preset',
            url: url,
            code: code,
            name: name,
            thumb: url
          };
          // Atualiza código da estampa e referência se houver
          if (codigoEstampa) codigoEstampa.textContent = code || 'Código da Estampa';
          window.refCm = refcm;
          window.refNome = refnome;
          if (typeof window.updateRefCmBox === 'function') window.updateRefCmBox();
          if (typeof updateConfigModal === 'function') updateConfigModal();
        });
        thumbsDiv.appendChild(thumb);
      });
      catDiv.appendChild(thumbsDiv);
      compartimentosEstampa.appendChild(catDiv);
    });
    // Chama renderWatermarkOverlay após carregar as estampas do backend
    renderWatermarkOverlay();
  });
}
// Chama ao carregar a página
carregarEstampasPrincipais();

// Adiciona a marca d'água visualmente sobre a estampa, atrás do mockup
function renderWatermarkOverlay() {
  const estampaBg = document.getElementById('estampaBg');
  if (!estampaBg) return;
  let watermarkImg = document.getElementById('watermarkOverlay');
  if (watermarkImg) watermarkImg.remove();
  if (estampasJson.watermark && estampasJson.watermark.enabled && estampasJson.watermark.url) {
    watermarkImg = document.createElement('img');
    watermarkImg.id = 'watermarkOverlay';
    watermarkImg.src = estampasJson.watermark.url;
    watermarkImg.style.position = 'absolute';
    watermarkImg.style.top = '0';
    watermarkImg.style.left = '0';
    watermarkImg.style.width = '100%';
    watermarkImg.style.height = '100%';
    watermarkImg.style.objectFit = 'contain';
    //watermarkImg.style.opacity = '0.35';
    watermarkImg.style.pointerEvents = 'none';
    watermarkImg.style.zIndex = '1';
    estampaBg.parentNode.insertBefore(watermarkImg, estampaBg.nextSibling);
  }
}
// Chame renderWatermarkOverlay sempre que carregar estampas ou trocar estampa
document.addEventListener('DOMContentLoaded', function() {
 carregarEstampasPrincipais(); // Carrega as estampas e categorias
  renderWatermarkOverlay();     // Exibe a marca d'água se existir
});
carregarEstampasPrincipais();

// --- INÍCIO DO BLOCO ÚNICO DO CHAT IA ---
if (!document.getElementById('iaDrawer')) {
  const iaDrawer = document.createElement('aside');
  iaDrawer.id = 'iaDrawer';
  iaDrawer.innerHTML = `
    <div id="iaDrawerMediaPanel" class="ia-drawer-media-panel">
      <button id="iaGalleryToggle" class="ia-gallery-panel-toggle" title="Imagens IA">
        <span>Imagens</span>
        <svg width="22" height="22" fill="none" stroke="#783D19" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2"/><path d="M16 3v4M8 3v4"/></svg>
      </button>
      <div id="iaDrawerGallery" class="ia-drawer-gallery open">
        <div id="iaDrawerGalleryImgs" class="ia-drawer-gallery-imgs"></div>
      </div>
    </div>
    <div class="ia-drawer-main">
      <div class="ia-drawer-header">
        <div class="ia-avatar ia-avatar-lg">🤖</div>
        <div class="ia-drawer-title">
          <h3>Nick</h3>
          <span>Assistente virtual</span>
        </div>
        <button id="closeIaDrawer" title="Fechar">×</button>
      </div>
      <div id="iaDrawerChat" class="ia-drawer-chat"></div>
      <form id="iaDrawerForm" class="ia-drawer-form">
        <label for="iaDrawerImageInput" id="iaDrawerAddImageBtn">
          <svg width="22" height="22" fill="none" stroke="#783D19" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
          <input type="file" id="iaDrawerImageInput" accept="image/*" style="display:none;">
        </label>
        <textarea id="iaDrawerPrompt" placeholder="Digite sua mensagem..."></textarea>
        <button id="iaDrawerEnviarBtn" type="submit">Enviar</button>
      </form>
    </div>
    <div id="iaDrawerResize" class="ia-drawer-resize"></div>
  `;
  document.body.appendChild(iaDrawer);
}

if (!document.getElementById('iaDrawerStyle')) {
  const style = document.createElement('style');
  style.id = 'iaDrawerStyle';
  style.textContent = `
#iaDrawer { position: fixed; top: 0; left: 0; height: 100vh; background: linear-gradient(120deg,#fff 80%,#F9EBC7 100%); box-shadow: 8px 0 40px #783d1930; border-right: 3px solid #B99470; z-index: 10050; display: flex; flex-direction: row; transform: translateX(-110%); transition: transform 0.45s cubic-bezier(.39,1.52,.37,.98); will-change: transform; overflow: hidden; width: 540px; }
#iaDrawer.open { transform: translateX(0); }
.ia-drawer-media-panel { width: 110px; min-width: 90px; background: linear-gradient(120deg,#F9EBC7 80%,#B99470 100%); border-right: 2px solid #B99470; display: flex; flex-direction: column; align-items: center; padding: 0 0 0 0; position: relative; z-index: 3; }
.ia-gallery-panel-toggle { width: 100%; background: #B99470; color: #fff; border: none; border-radius: 0 0 18px 0; font-weight: 700; font-size: 1.08rem; padding: 14px 0 10px 0; display: flex; align-items: center; justify-content: center; gap: 7px; cursor: pointer; box-shadow: 0 2px 8px #b9947030; transition: background 0.18s, color 0.18s; }
.ia-gallery-panel-toggle:hover { background: #783D19; color: #fff; }
.ia-drawer-gallery { width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center; background: none; border: none; box-shadow: none; padding: 12px 0 0 0; overflow-y: auto; transition: max-height 0.38s cubic-bezier(.39,1.52,.37,.98), opacity 0.28s; }
.ia-drawer-gallery-imgs { display: flex; flex-direction: column; gap: 18px; width: 100%; align-items: center; }
.ia-gallery-card { background: #fff; border-radius: 14px; box-shadow: 0 2px 16px #b9947030; border: 2px solid #B99470; padding: 6px 6px 4px 6px; display: flex; flex-direction: column; align-items: center; position: relative; transition: box-shadow 0.18s, border 0.18s, transform 0.18s; width: 86px; }
.ia-gallery-card:hover { box-shadow: 0 8px 32px #783d1920; border: 2px solid #783D19; transform: translateY(-2px) scale(1.03); }
.ia-gallery-thumb-wrap { position: relative; width: 100%; display: flex; justify-content: center; }
.ia-gallery-thumb { width: 100%; max-width: 74px; max-height: 74px; border-radius: 10px; object-fit: cover; box-shadow: 0 2px 8px #783d1930; background: #fff; cursor: pointer; transition: box-shadow 0.18s, transform 0.18s; }
.ia-gallery-card:hover .ia-gallery-thumb { box-shadow: 0 6px 18px #783d192a; transform: scale(1.04); }
.ia-gallery-apply { display: none; position: absolute; bottom: 6px; right: 6px; background: #F9EBC7; border: 2px solid #B99470; border-radius: 50%; width: 28px; height: 28px; box-shadow: 0 2px 8px #b9947030; cursor: pointer; align-items: center; justify-content: center; transition: background 0.18s, border 0.18s, transform 0.18s; }
.ia-gallery-card:hover .ia-gallery-apply { display: flex; }
.ia-gallery-apply:hover { background: #B99470; border: 2px solid #783D19; }
.ia-gallery-meta { display: flex; justify-content: space-between; width: 100%; font-size: 0.93em; color: #5F6F52; margin-top: 4px; opacity: 0.85; padding: 0 2px; }
.ia-drawer-main { flex: 1 1 0; display: flex; flex-direction: column; height: 100vh; position: relative; }
.ia-drawer-header { display: flex; align-items: center; gap: 18px; padding: 28px 28px 18px 28px; background: linear-gradient(90deg,#F9EBC7 80%,#B99470 100%); border-bottom: 2px solid #B99470; position: sticky; top: 0; z-index: 2; }
.ia-drawer-title h3 { margin: 0; color: #783D19; font-size: 1.32rem; font-family: 'Poppins', 'Inter', Arial, sans-serif; font-weight: 700; }
.ia-drawer-title span { font-size: 1.01rem; color: #5F6F52; opacity: 0.85; }
#closeIaDrawer { background: none; border: none; font-size: 2.2rem; color: #b99470; cursor: pointer; margin-left: auto; transition: color 0.18s, transform 0.18s; }
#closeIaDrawer:hover { color: #783D19; transform: scale(1.15) rotate(8deg); }
.ia-drawer-chat { flex: 1 1 0; overflow-y: auto; padding: 32px 28px 18px 28px; display: flex; flex-direction: column; gap: 22px; background: transparent; scroll-behavior: smooth; }
.ia-msg-row { display: flex; align-items: flex-end; gap: 14px; }
.ia-msg-row.ia { flex-direction: row; justify-content: flex-start; }
.ia-msg-row.user { flex-direction: row-reverse; justify-content: flex-end; }
.ia-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg,#F9EBC7 60%,#B99470 100%); display: flex; align-items: center; justify-content: center; font-size: 2em; box-shadow: 0 2px 12px #B9947033; }
.ia-avatar.user { background: linear-gradient(135deg,#B99470 60%,#F9EBC7 100%); color: #fff; }
.ia-msg-bubble { max-width: 60vw; padding: 16px 20px; border-radius: 18px; font-size: 1.09rem; line-height: 1.6; font-family: 'Poppins', 'Inter', Arial, sans-serif; word-break: break-word; box-shadow: 0 2px 16px #B9947033; margin-bottom: 2px; position: relative; transition: box-shadow 0.18s, background 0.18s; }
.ia-msg-row.ia .ia-msg-bubble { background: linear-gradient(120deg, #783D19 80%, #5F6F52 100%); color: #fff; border-bottom-left-radius: 10px; border-top-right-radius: 28px; margin-left: 0; margin-right: auto; }
.ia-msg-row.user .ia-msg-bubble { background: linear-gradient(120deg, #F9EBC7 80%, #B99470 100%); color: #2d2d2d; border-bottom-right-radius: 10px; border-top-left-radius: 28px; margin-right: 0; margin-left: auto; border: 2px solid #B99470; }
.ia-msg-bubble img, .ia-msg-img-preview { max-width: 220px; max-height: 220px; border-radius: 12px; margin-top: 12px; display: block; box-shadow: 0 2px 12px #783d1930; cursor: pointer; background: #fff; }
.ia-drawer-form { display: flex; align-items: flex-end; gap: 12px; padding: 18px 22px 22px 22px; background: #f9ebc7; border-top: 1.5px solid #f9ebc7; position: absolute; left: 0; bottom: 0; width: 100%; z-index: 10; box-shadow: 0 -2px 12px #B9947010; }
#iaDrawerAddImageBtn { display: flex; align-items: center; justify-content: center; width: 38px; height: 38px; background: #fff; border-radius: 10px; cursor: pointer; border: 1.5px solid #b99470; margin-bottom: 2px; transition: background 0.18s; }
#iaDrawerAddImageBtn:hover { background: #F9EBC7; border: 1.5px solid #783D19; }
#iaDrawerAddImageBtn.selected { background: #B99470; border: 1.5px solid #783D19; }
#iaDrawerAddImageBtn svg { transition: transform 0.18s; }
#iaDrawerAddImageBtn.selected svg { transform: scale(1.12) rotate(12deg); }
#iaDrawerPrompt { flex: 1; min-height: 38px; max-height: 90px; padding: 10px 12px; border-radius: 10px; border: 1.5px solid #b99470; font-size: 1.08rem; resize: vertical; background: #fff; transition: border 0.18s, box-shadow 0.18s; box-shadow: 0 1px 6px #B9947030; }
#iaDrawerPrompt:focus { outline: 2px solid #783D19; border: 2px solid #783D19; box-shadow: 0 2px 12px #783d1930; }
#iaDrawerEnviarBtn { height: 38px; padding: 0 22px; font-size: 1.08rem; border-radius: 10px; background: linear-gradient(90deg, #783D19 0%, #B99470 100%); color: #fff; border: none; font-family: 'Poppins', 'Inter', Arial, sans-serif; font-weight: 700; box-shadow: 0 2px 10px #783d1922; cursor: pointer; transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.23s cubic-bezier(.55,.06,.68,.19); }
#iaDrawerEnviarBtn:hover { background: linear-gradient(90deg, #5F6F52 0%, #783D19 100%); color: #fff; transform: scale(1.06); }
#iaDrawerResize { position: absolute; top: 0; right: 0; width: 10px; height: 100%; cursor: ew-resize; z-index: 100; background: transparent; }
#iaDrawerResize:hover { background: #B9947033; }
@media (max-width: 540px) { #iaDrawer { width: 100vw; min-width: 0; } .ia-drawer-header, .ia-drawer-chat, .ia-drawer-form, .ia-drawer-gallery { padding-left: 8px; padding-right: 8px; } .ia-drawer-gallery-imgs { flex-direction: row; flex-wrap: wrap; gap: 10px; } .ia-drawer-form, .ia-drawer-gallery { width: 100vw; left: 0; } }
`;
  document.head.appendChild(style);
}

// Lógica de abrir/fechar drawer IA
const abrirIaBtn = document.getElementById('abrirIaBtn');
const iaDrawer = document.getElementById('iaDrawer');
const closeIaDrawer = document.getElementById('closeIaDrawer');
if (abrirIaBtn && iaDrawer) {
  abrirIaBtn.onclick = () => {
    iaDrawer.classList.add('open');
    renderIaDrawerChat();
    renderIaDrawerGallery();
  };
}
if (closeIaDrawer && iaDrawer) {
  closeIaDrawer.onclick = () => iaDrawer.classList.remove('open');
}
const iaGalleryToggle = document.getElementById('iaGalleryToggle');
const iaDrawerGallery = document.getElementById('iaDrawerGallery');
if (iaGalleryToggle && iaDrawerGallery) {
  iaGalleryToggle.onclick = () => iaDrawerGallery.classList.toggle('open');
}

// Estado do chat IA
let iaChatHistory = [];
let iaImageBase64 = null;
let iaGalleryImages = [];

// Função para renderizar o chat IA no drawer
function renderIaDrawerChat() {
  const chat = document.getElementById('iaDrawerChat');
  if (!chat) return;
  chat.innerHTML = iaChatHistory.map((msg, idx) => {
    let imageHtml = '';
    if (msg.image) {
      imageHtml = `
        <div style="margin-top:10px;">
          <img src="${msg.image}" class="ia-msg-img-preview" style="max-width:220px;max-height:220px;cursor:pointer;border-radius:14px;box-shadow:0 2px 12px #783d1930;" data-idx="${idx}">
        </div>
      `;
    }
    // Botão de copiar só para mensagens da IA
    const copyBtn = msg.role === 'ia' ? `
      <div class="ia-copy-btn-row">
        <button class="ia-copy-btn" data-idx="${idx}" title="Copiar resposta">
          <svg width="18" height="18" fill="none" stroke="#783D19" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15V5a2 2 0 0 1 2-2h10"/></svg>
        </button>
      </div>
    ` : '';
    const content = `
      <div style="display:flex;flex-direction:column;align-items:${msg.role === 'user' ? 'flex-end' : 'flex-start'};width:100%;margin-top:2px;">
        <div class='ia-msg-bubble' ${msg.role === 'ia' ? "style='white-space:normal'" : ""}>${msg.role === 'ia' ? (msg.text || '') : escapeHtml(msg.text || '')}${imageHtml}</div>
        ${copyBtn}
      </div>
    `;
    if (msg.role === 'user') {
      return `<div class='ia-msg-row user'><div class='ia-avatar user'>👦🏻</div>${content}</div>`;
    } else if (msg.role === 'ia') {
      return `<div class='ia-msg-row ia'><div class='ia-avatar'>🤖</div>${content}</div>`;
    }
    return '';
  }).join('');
  setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 50);
  // Evento de copiar
  chat.querySelectorAll('.ia-copy-btn').forEach(btn => {
    btn.onclick = function(e) {
      e.preventDefault();
      const idx = btn.getAttribute('data-idx');
      const msg = iaChatHistory[idx];
      let textToCopy = msg.text || '';
      if (msg.image) textToCopy += '\n' + msg.image;
      navigator.clipboard.writeText(textToCopy);
      btn.classList.add('copied');
      setTimeout(() => btn.classList.remove('copied'), 900);
    };
  });
  // Evento de abrir imagem grande
  chat.querySelectorAll('.ia-msg-img-preview').forEach(img => {
    img.onclick = function() { abrirModalImagemGrande(img.src); };
  });
}

// Função para renderizar a galeria IA no drawer
function renderIaDrawerGallery() {
  const panel = document.getElementById('iaDrawerGalleryImgs');
  if (!panel) return;
  panel.innerHTML = '';
  iaGalleryImages.forEach((img, idx) => {
    const card = document.createElement('div');
    card.className = 'ia-gallery-card';
    card.innerHTML = `
      <div class="ia-gallery-thumb-wrap">
        <img src="${img}" class="ia-gallery-thumb" alt="Estampa IA">
      </div>
    `;
    card.querySelector('.ia-gallery-thumb').onclick = () => {
      // Aplica no mockup
      const estampaBg = document.getElementById('estampaBg');
      if (estampaBg) {
        estampaBg.style.backgroundImage = `url('${img}')`;
        estampaBg.style.backgroundSize = '100%';
        estampaBg.style.backgroundPosition = '50% 50%';
        window.estampaState = {
          type: 'ia',
          url: img,
          code: '',
          name: 'Estampa IA',
          thumb: img
        };
      }
    };
    panel.appendChild(card);
  });
}

// Formulário IA drawer
const iaDrawerForm = document.getElementById('iaDrawerForm');
const iaDrawerPrompt = document.getElementById('iaDrawerPrompt');
const iaDrawerAddImageBtn = document.getElementById('iaDrawerAddImageBtn');
const iaDrawerImageInput = document.getElementById('iaDrawerImageInput');
if (iaDrawerForm) {
  iaDrawerForm.onsubmit = async function(e) {
    e.preventDefault();
    const prompt = iaDrawerPrompt.value.trim();
    if (!prompt && !iaImageBase64) return;
    const imageToSend = iaImageBase64;
    iaChatHistory.push({ role: 'user', text: prompt, image: imageToSend ? imageToSend : null });
    renderIaDrawerChat();
    iaDrawerPrompt.value = '';
    iaImageBase64 = null;
    iaDrawerAddImageBtn.classList.remove('selected');
    iaChatHistory.push({ role: 'ia', text: 'Aguarde resposta da IA...', image: null });
    renderIaDrawerChat();
    fetch('https://estampas-oda7.onrender.com/dalle', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, image: imageToSend })
    })
    .then(res => res.json())
      .then(data => {
      iaChatHistory = iaChatHistory.filter((msg, idx) => !(msg.role === 'ia' && msg.text === 'Aguarde resposta da IA...'));
      let resposta = '';
      if (typeof data.output === 'string') {
        resposta = data.output;
      } else if (data.output && typeof data.output === 'object') {
        resposta = data.output.text || data.output.message || data.output.content || '';
        if (!resposta) resposta = JSON.stringify(data.output, null, 2);
      } else if (typeof data === 'string') {
        resposta = data;
      } else if (typeof data === 'object' && Object.keys(data).length > 0) {
        resposta = JSON.stringify(data, null, 2);
      } else {
        resposta = 'A IA não retornou resposta.';
      }
      iaChatHistory.push({ role: 'ia', text: resposta, image: data.image || null });
      if (data.image) {
        iaGalleryImages.push(data.image);
        renderIaDrawerGallery();
      }
      renderIaDrawerChat();
    })
    .catch(err => {
      iaChatHistory = iaChatHistory.filter((msg, idx) => !(msg.role === 'ia' && msg.text === 'Aguarde resposta da IA...'));
      iaChatHistory.push({ role: 'ia', text: 'Erro: ' + err.message, image: null });
      renderIaDrawerChat();
    });
  };
}
if (iaDrawerImageInput && iaDrawerAddImageBtn) {
  iaDrawerImageInput.onchange = async function(e) {
    if (iaDrawerImageInput.files && iaDrawerImageInput.files[0]) {
      const file = iaDrawerImageInput.files[0];
      iaImageBase64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
      iaDrawerAddImageBtn.classList.add('selected');
    } else {
      iaImageBase64 = null;
      iaDrawerAddImageBtn.classList.remove('selected');
    }
  };
}
// --- FIM DO BLOCO ÚNICO DO CHAT IA ---
</script>