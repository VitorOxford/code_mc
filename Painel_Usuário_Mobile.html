<html>
<head>
<style>
/* =================================================================== */
/* 1. GERAL & RESET (Mobile-First)
/* =================================================================== */
:root {
  --cor-primaria: #783D19;
  --cor-secundaria: #F9EBC7;
  --cor-terciaria: #B99470;
  --cor-quaternaria: #5F6F52;
  --cor-background: #FAF4EC;
  --cor-fundo-cards: #fff;
  --cor-borda: #B99470;
  --cor-hover: #5F6F52;
  --cor-branco: #fff;
  --cor-sombra: rgba(120, 61, 25, 0.13);
  --cor-btn: linear-gradient(90deg, #783D19 0%, #B99470 100%);
  --cor-btn-hover: linear-gradient(90deg, #5F6F52 0%, #783D19 100%);
  --bottom-nav-height: 70px; /* Altura da navegação inferior */
}

/* Mantém o reset original e fontes */
body,
html {
  background: var(--cor-background);
  margin: 0;
  padding: 0;
  font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
  color: var(--cor-primaria);
  -webkit-tap-highlight-color: transparent; /* Remove highlight de toque */
}

* {
  box-sizing: border-box;
}

/* Animações e Efeitos de Carregamento */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}


/* =================================================================== */
/* 2. ESTRUTURA PRINCIPAL (Mobile Layout)
/* =================================================================== */
.interface-wrapper {
  /* Wrapper agora controla o layout mobile */
  width: 100%;
  max-width: 900px; /* Limite para layout mobile/tablet */
  height: 100vh;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
  background-color: var(--cor-background);
}

.mobile-header {
  padding: 12px 16px;
  display: flex;
  justify-content: center;
  align-items: center;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  z-index: 100;
}

/* Código da estampa movido para o header */
.codigo-estampa-remaster {
  font-size: 0.9rem;
  font-weight: bold;
  color: var(--cor-primaria);
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(5px);
  padding: 8px 16px;
  border-radius: 20px;
  border: 1px solid var(--cor-terciaria);
  text-align: center;
  box-shadow: 0 2px 8px #0000001a;
}

/* Área principal do mockup */
.center-mockup {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
  /* Garante que o padding não cause overflow */
  padding-bottom: calc(var(--bottom-nav-height) + 16px);
  overflow: hidden;
  position: relative;
}

.mockup-content {
  width: 100%;
  /* Use max-width para não ficar excessivamente grande em telas largas */
  max-width: 450px;
  /* Use aspect-ratio para manter a proporção (ex: 7/8) */
  aspect-ratio: 7 / 8;
  /* Garante que a altura não ultrapasse o espaço visível */
  max-height: 75vh;
  position: relative;
  border-radius: 24px;
  border: 3px solid var(--cor-borda);
  background: var(--cor-fundo-cards);
  overflow: hidden;
  box-shadow: 0 8px 36px #783d191a;
  display: flex;
  align-items: center;
  justify-content: center;
}

.estampa-bg, .mockup-png {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0; left: 0;
  background-repeat: no-repeat;
  background-position: 50% 50%;
  background-size: 100%;
  z-index: 1;
}

.mockup-png {
  object-fit: contain;
  z-index: 2;
}

/* Referência de CM */
.ref-cm-box {
    position: absolute;
    left: 12px;
    top: 12px;
    background: #fffb;
    color: #783D19;
    border: 1.5px solid #b99470;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: bold;
    padding: 5px 10px;
    box-shadow: 0 2px 10px #783d1922;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 7px;
    pointer-events: none;
    backdrop-filter: blur(2px);
}
.ref-cm-box span#refCmNome {font-weight: bold; font-size: 0.8rem; color: #5F6F52;}
.ref-cm-box span#refCmValue {color: #783D19; font-family: monospace; font-size: 0.9rem;}


/* =================================================================== */
/* 3. NAVEGAÇÃO INFERIOR (Bottom Navigation)
/* =================================================================== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: var(--bottom-nav-height);
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
  border-top: 1px solid var(--cor-sombra);
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 1000;
  box-shadow: 0 -4px 20px #0000001a;
}

.nav-button {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  background: none;
  border: none;
  color: var(--cor-primaria);
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 12px;
  transition: background 0.2s, color 0.2s;
}

.nav-button.active,
.nav-button:active {
  color: var(--cor-hover);
}

.nav-button svg {
  width: 24px;
  height: 24px;
  stroke: currentColor;
  stroke-width: 2;
  fill: none;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* =================================================================== */
/* 4. PAINÉIS DESLIZANTES (Bottom Sheets)
/* =================================================================== */
.backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.4);
  z-index: 1010;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease-in-out;
}

.backdrop.is-open {
  opacity: 1;
  pointer-events: auto;
}

.bottom-sheet {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  max-height: 85vh;
  background: var(--cor-fundo-cards);
  border-top-left-radius: 24px;
  border-top-right-radius: 24px;
  box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.15);
  z-index: 1020;
  transform: translateY(105%);
  transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  padding: 16px;
  padding-bottom: 32px;
  overflow-y: auto;
}

.bottom-sheet.is-open {
  transform: translateY(0);
}

.sheet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.sheet-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--cor-primaria);
}

.sheet-close-btn {
  background: #f0f0f0;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 1.5rem;
  font-weight: 300;
  color: #888;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* =================================================================== */
/* 5. CONTEÚDO DOS PAINÉIS
/* =================================================================== */

/* --- Painel de Edição (Zoom, Mover) --- */
.editor-content {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.tool-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.tool-label {
  font-size: 1rem;
  font-weight: bold;
  color: var(--cor-primaria);
}

.zoom-controls {
  display: flex;
  align-items: center;
  gap: 16px;
  width: 100%;
  justify-content: center;
}

/* Slider de zoom agora é horizontal */
.zoom-slider-wrapper {
  flex: 1;
  height: 38px;
  display: flex;
  align-items: center;
}
.zoom-slider-vertical {
  width: 100%;
  height: 8px;
  accent-color: var(--cor-terciaria);
  -webkit-appearance: none;
  background: #ddd;
  border-radius: 8px;
  outline: none;
}
.zoom-slider-vertical::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 24px;
  height: 24px;
  background: var(--cor-primaria);
  border-radius: 50%;
  cursor: pointer;
}
.zoom-slider-vertical::-moz-range-thumb {
  width: 24px;
  height: 24px;
  background: var(--cor-primaria);
  border-radius: 50%;
  cursor: pointer;
}

.circle-btn {
  background: var(--cor-secundaria);
  color: var(--cor-primaria);
  border: none;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  font-size: 1.8rem;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 1px 8px #0000001a;
  flex-shrink: 0;
}

.joystick-area { display: flex; flex-direction: column; align-items: center; }
.joystick-base { width: 120px; height: 120px; border: 4px solid var(--cor-secundaria); background: var(--cor-terciaria); border-radius: 50%; position: relative; }
.joystick-handle { width: 42px; height: 42px; background: var(--cor-primaria); border-radius: 50%; position: absolute; top: calc(50% - 21px); left: calc(50% - 21px); cursor: grab; box-shadow: 0 2px 8px #00000033; border: 3px solid var(--cor-branco); }

.actions-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 16px;
}

.btn-primary, .btn-upload-remaster {
  border: none;
  border-radius: 16px;
  font-size: 0.95rem;
  font-weight: 700;
  padding: 16px 10px;
  cursor: pointer;
  box-shadow: 0 2px 10px #0000001a;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  transition: transform 0.2s, box-shadow 0.2s;
}
.btn-primary { background: var(--cor-btn); color: var(--cor-branco); }
.btn-upload-remaster { background: var(--cor-btn); color: var(--cor-branco); }
#falarRepresentanteBtn { background: #25D366; color: #fff; }

.btn-primary:active, .btn-upload-remaster:active { transform: scale(0.96); }

/* Balão da IA */
#iaBalloonTip { /* Mantido como no original com pequenos ajustes */
    display:none;position:fixed;z-index:10001;
    max-width:200px;background:#fffbe9;color:#783D19;
    border:2px solid #b99470;border-radius:14px;padding:13px 18px;
    font-size:1rem;box-shadow:0 4px 24px #783d1912;
    animation:ia-balloon-in 0.7s cubic-bezier(.39,1.52,.37,.98);
}
@keyframes ia-balloon-in { 0% { opacity:0; transform:translateY(18px) scale(0.92);} 100% { opacity:1; transform:translateY(0) scale(1);} }


/* --- Painel de Itens (Mockups, Estampas, Tecidos) --- */
.tabs-categorias {
  display: flex;
  gap: 8px;
  border-bottom: 1px solid #eee;
  margin-bottom: 20px;
  padding: 0 8px;
}

.tab-btn-remaster {
  font-size: 1rem;
  font-weight: 700;
  border: none;
  border-bottom: 3px solid transparent;
  padding: 12px 8px;
  background: none;
  color: var(--cor-terciaria);
  cursor: pointer;
  transition: color 0.2s, border-color 0.2s;
  flex: 1;
  text-align: center;
}

.tab-btn-remaster.active {
  color: var(--cor-primaria);
  border-bottom-color: var(--cor-primaria);
}

.compartimentos-categorias-remaster { /* Mantém a classe original para compatibilidade com JS */
  display: none; /* JS controla a visibilidade */
}
.compartimentos-categorias-remaster.active {
  display: flex;
  flex-direction: column;
  gap: 20px;
  animation: fadeIn 0.3s;
}

.categoria-box-remaster {
  background: transparent;
  padding: 0;
  box-shadow: none;
  border: none;
}

.categoria-title-remaster {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--cor-primaria);
  margin-bottom: 12px;
  padding-left: 8px;
}

.categoria-thumbnails-remaster {
  display: flex;
  gap: 16px;
  overflow-x: auto;
  padding: 8px;
  /* Melhora o scroll em mobile */
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none; /* Firefox */
}
.categoria-thumbnails-remaster::-webkit-scrollbar {
  display: none; /* Chrome, Safari, Opera */
}

.thumbnail {
  width: 72px;
  height: 72px;
  border-radius: 18px;
  overflow: hidden;
  background-size: cover;
  background-position: center;
  cursor: pointer;
  border: 2px solid var(--cor-terciaria);
  box-shadow: 0 2px 10px #783d191a;
  transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
  flex-shrink: 0; /* Impede que os itens encolham */
  background-color: var(--cor-branco);
}
.thumbnail:hover, .thumbnail.selected {
  transform: scale(1.08);
  border-color: var(--cor-primaria);
  box-shadow: 0 6px 18px #783d192a;
}
.mockup-circle, .estampa-circle { width: 100%; height: 100%; object-fit: cover; }
.estampa-circle { background-size: cover; background-position: center; }
.tecido-thumbnail { border-radius: 18px; }


/* =================================================================== */
/* 6. MODAIS (Upload, Config, Créditos)
/* =================================================================== */
/* Estilo geral para modais, adaptado para mobile */
.modal-upload-remaster, .modal-info-remaster, #creditosModal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(40, 20, 10, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 16px;
  animation: fadeIn 0.3s;
}

.modal-content-remaster, #creditosModal > div {
  background: var(--cor-fundo-cards);
  border-radius: 24px;
  box-shadow: 0 10px 40px #783d1916;
  padding: 24px;
  width: 100%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

.close-x-modal, #closeCreditosModal {
  position: absolute;
  top: 16px;
  right: 16px;
  background: none;
  border: none;
  font-size: 2rem;
  line-height: 1;
  color: #b99470;
  cursor: pointer;
}

/* Modal de Upload */
.upload-dropzones {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 100%;
  margin: 18px 0;
}
.drop-zone-remaster {
  border: 2px dashed var(--cor-primaria);
  border-radius: 16px;
  background: #f5e7d433;
  padding: 30px 15px;
  text-align: center;
  color: var(--cor-primaria);
  font-weight: bold;
}
.btn-cancel-upload {
  background: var(--cor-terciaria);
  color: var(--cor-primaria);
  border: none;
  border-radius: 12px;
  font-weight: 600;
  margin-top: 16px;
  padding: 12px 30px;
  cursor: pointer;
}

/* Modal de Configuração */
.info-modal-large { max-width: 500px; }
.info-flex-row { flex-direction: column; align-items: center; gap: 20px; width: 100%;}
.miniaturas-info { flex-direction: row; gap: 20px; }
.miniatura-thumb { width: 90px; height: 90px; border-radius: 16px;}
.miniatura-mockup-label, .miniatura-estampa-label { font-size: 0.9rem; text-align: center; }
.config-table-remaster { font-size: 0.9rem; }
.config-table-remaster .config-key { font-weight: 600; text-align: left; }
.config-table-remaster .config-value { font-size: 0.85rem; }
.modal-actions-row { flex-wrap: wrap; justify-content: center; gap: 10px; }
.modal-actions-row button { flex-basis: 45%; font-size: 0.9rem; padding: 12px 5px; }
.btn-toggle-raw, .btn-secundary { font-size: 0.9rem; padding: 10px 18px; }

/* =================================================================== */
/* 7. CHAT IA (Abre em tela cheia)
/* =================================================================== */
#iaDrawer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--cor-fundo-cards);
  z-index: 10050;
  display: flex; /* Mantido para JS original */
  flex-direction: column; /* Alterado para layout de tela cheia */
  transform: translateX(100%); /* Começa fora da tela à direita */
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  will-change: transform;
}
#iaDrawer.open {
  transform: translateX(0);
}

/* Remove painel de mídia lateral, integra ao header */
#iaDrawerMediaPanel { display: none; }

.ia-drawer-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100%;
}

.ia-drawer-header {
  padding: 16px;
  gap: 12px;
  background: var(--cor-fundo-cards);
  border-bottom: 1px solid #eee;
  flex-shrink: 0; /* Impede que o header encolha */
}
.ia-drawer-title h3 { font-size: 1.1rem; }
.ia-drawer-title span { font-size: 0.85rem; }
#closeIaDrawer { font-size: 2rem; }

.ia-drawer-chat {
  flex: 1;
  padding: 16px;
  gap: 18px;
}
.ia-msg-bubble {
  max-width: 80%; /* Bolhas de chat mais largas */
  padding: 12px 16px;
  font-size: 1rem;
}

.ia-drawer-form {
  padding: 12px;
  gap: 8px;
  background: #f9f9f9;
  border-top: 1px solid #eee;
  flex-shrink: 0; /* Impede que o form encolha */
}
#iaDrawerPrompt {
  min-height: 42px;
  font-size: 1rem;
  padding: 10px 14px;
}
#iaDrawerEnviarBtn, #iaDrawerAddImageBtn {
  height: 42px;
}

/* =================================================================== */
/* 8. DESKTOP & TELAS MAIORES (Media Query)
/* =================================================================== */
@media (min-width: 901px) {
  /* Restaura layout original para desktop */
  body, html {
    background: var(--cor-background);
  }

  .interface-wrapper {
    flex-direction: row;
    width: 1420px;
    height: 860px;
  }

  /* Esconde layout mobile */
  .mobile-header, .bottom-nav, .bottom-sheet, .backdrop {
    display: none !important;
  }

  /* Restaura painéis laterais (usando as classes e IDs originais) */
  .painel-lateral-remaster, .painel-lateral-categorias {
    display: flex !important; /* Força a exibição */
    position: static;
    transform: none;
    box-shadow: 2px 0 18px var(--cor-sombra);
    animation: none;
  }

  /* Re-cria a estrutura original do HTML visualmente */
  .produto-pagina-remasterizada {
    display: flex;
    flex-direction: row;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .painel-lateral-remaster {
      width: 220px;
      min-width: 200px;
      flex-direction: column;
      align-items: center;
      gap: 36px;
      padding: 46px 18px 34px 18px;
      border-radius: 0;
      order: 1; /* Esquerda */
  }

  .center-mockup {
    order: 2; /* Centro */
    flex: 1 1 0;
    min-width: 0;
    padding: 50px 12px 40px 12px;
  }

  .painel-lateral-categorias {
      width: 345px;
      min-width: 270px;
      flex-direction: column;
      align-items: flex-start;
      padding: 36px 22px 24px 28px;
      border-radius: 0;
      order: 3; /* Direita */
  }

  /* Ajustes finos para reverter estilos mobile */
  .codigo-estampa-remaster {
    position: static;
    font-size: 1.08rem;
    padding: 10px 28px;
    border-radius: 14px;
    margin-bottom: 20px;
    min-width: 190px;
  }
  .mockup-content {
    width: 700px;
    height: 800px;
  }
  .zoom-controls { flex-direction: column; gap: 8px; }
  .zoom-slider-wrapper { width: 38px; height: 120px; }
  .zoom-slider-vertical { transform: translate(-50%, -50%) rotate(-90deg); width: 120px; height: 12px; }
  .tabs-categorias { flex-direction: row; }
  .categoria-thumbnails-remaster { flex-wrap: wrap; } /* Permite quebrar linha no desktop */

  /* Mantém o chat como drawer lateral no desktop */
  #iaDrawer {
    width: 540px;
    height: 100vh;
    transform: translateX(-110%);
    border-right: 3px solid #B99470;
    box-shadow: 8px 0 40px #783d1930;
    flex-direction: row; /* Volta a ser lateral */
  }
  #iaDrawerMediaPanel { display: flex; } /* Mostra painel de mídia no desktop */
  .ia-drawer-main { flex: 1; }
  .ia-drawer-header, .ia-drawer-chat, .ia-drawer-form {
      padding-left: 28px;
      padding-right: 28px;
  }
}
</style>
</head>
<body>
<div class="interface-wrapper">

  <div class="mobile-header">
    <div class="codigo-estampa-remaster" id="codigoEstampa">Código da Estampa</div>
  </div>

  <main class="center-mockup">
    <div class="mockup-content">
      <div class="ref-cm-box" id="refCmBox" style="display:none;">
          <span id="refCmNome"></span>
          <span id="refCmValue"></span>
      </div>
      <div class="estampa-bg" id="estampaBg"></div>
      <img src="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/mockup_experimental_1.png?v=1746646882" class="mockup-png" />
    </div>
  </main>

  <nav class="bottom-nav">
    <button class="nav-button" id="nav-btn-edit" type="button" aria-label="Editar">
      <svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      <span>Editar</span>
    </button>
    <button class="nav-button" id="nav-btn-items" type="button" aria-label="Itens">
       <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
      <span>Itens</span>
    </button>
    <button class="nav-button" id="abrirIaBtn" type="button" aria-label="Assistente IA">
      <svg viewBox="0 0 24 24"><path d="M12 8V4H8"/><rect x="4" y="12" width="8" height="8" rx="2"/><path d="M20 12h-4"/><path d="M16 8h4"/></svg>
      <span>IA</span>
    </button>
    </nav>

  <div id="iaBalloonTip" style="display:none;">
    <span style="font-weight:bold;display:block;margin-bottom:3px;">Alguma dúvida?</span>
    Eu posso te ajudar!
    <span style="position:absolute;left:-18px;top:22px;width:0;height:0;border-top:10px solid transparent;border-bottom:10px solid transparent;border-right:18px solid #fffbe9;filter:drop-shadow(-2px 0 #b99470);"></span>
  </div>

  <div class="backdrop" id="sheet-backdrop"></div>

  <div class="bottom-sheet" id="editor-panel">
    <div class="sheet-header">
      <h3 class="sheet-title">Ferramentas de Edição</h3>
      <button class="sheet-close-btn" type="button" aria-label="Fechar">×</button>
    </div>
    <div class="editor-content">
      <div class="tools-group">
          <div class="tool-block">
            <div class="tool-label">Zoom</div>
            <div class="zoom-controls">
              <button class="circle-btn" id="zoomOut" type="button" aria-label="Diminuir zoom">-</button>
              <div class="zoom-slider-wrapper">
                  <input type="range" id="zoomSlider" min="90" max="400" value="100" step="1" class="zoom-slider-vertical">
              </div>
              <button class="circle-btn" id="zoomIn" type="button" aria-label="Aumentar zoom">+</button>
            </div>
          </div>
          <div class="tool-block">
            <div class="tool-label">Mover Estampa</div>
            <div class="joystick-area">
              <div id="joystickBase" class="joystick-base">
                <div id="joystickHandle" class="joystick-handle"></div>
              </div>
            </div>
          </div>
      </div>
      <div class="actions-grid">
        <button id="showConfig" class="btn-primary" type="button">⚙️ Ver Config.</button>
        <button id="uploadButton" class="btn-upload-remaster" type="button">⬆️ Enviar</button>
        <button id="falarRepresentanteBtn" class="btn-primary" type="button" style="grid-column: 1 / -1;">
            <img src="https://cdn-icons-png.flaticon.com/512/733/733585.png" alt="WhatsApp" style="width:22px;height:22px;"> Falar com representante
        </button>
      </div>
    </div>
  </div>

  <div class="bottom-sheet" id="itens-panel">
     <div class="sheet-header">
      <h3 class="sheet-title">Selecionar Itens</h3>
      <button class="sheet-close-btn" type="button" aria-label="Fechar">×</button>
    </div>
    <div class="tabs-categorias">
        <button class="tab-btn-remaster active" id="tabMockupsBtn" type="button">🧢 Mockups</button>
        <button class="tab-btn-remaster" id="tabEstampasBtn" type="button">🖼️ Estampas</button>
        <button class="tab-btn-remaster" id="tabTecidosBtn" type="button">🧵 Tecidos</button>
    </div>
    <div id="compartimentosMockup" class="compartimentos-categorias-remaster active">
        <div class="categoria-box-remaster">
          <div class="categoria-title-remaster">👗 Vestidos</div>
          <div class="categoria-thumbnails-remaster">
            <div class="thumbnail" data-url="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/1_f1889a02-1ccc-4139-b9e5-5651a4f86f86.png?v=1747078489" data-type="preset" data-name="Vestido 01"><img src="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/1_f1889a02-1ccc-4139-b9e5-5651a4f86f86.png?v=1747078489" class="mockup-circle" /></div>
            <div class="thumbnail" data-url="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/3_bc04240f-3214-40c4-8c4e-060485f8368e.png?v=1747078489" data-type="preset" data-name="Vestido 02"><img src="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/3_bc04240f-3214-40c4-8c4e-060485f8368e.png?v=1747078489" class="mockup-circle" /></div>
          </div>
        </div>
        <div class="categoria-box-remaster">
          <div class="categoria-title-remaster">🛋️ Estofados</div>
          <div class="categoria-thumbnails-remaster">
             <div class="thumbnail" data-url="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/2_9ead9243-af01-40a9-84c4-3cc56dc690be.png?v=1747078489" data-type="preset" data-name="Almofada 01"><img src="https://cdn.shopify.com/s/files/1/0661/4574/6991/files/2_9ead9243-af01-40a9-84c4-3cc56dc690be.png?v=1747078489" class="mockup-circle" /></div>
          </div>
        </div>
    </div>
    <div id="compartimentosEstampa" class="compartimentos-categorias-remaster" style="display:none;"></div>
    <div id="compartimentosTecidos" class="compartimentos-categorias-remaster" style="display:none;"></div>
  </div>


  <div class="produto-pagina-remasterizada" style="display: none;">
    <aside class="painel-lateral-remaster"></aside>
    <main class="center-mockup"></main>
    <aside class="painel-lateral-categorias"></aside>
  </div>


  <div id="uploadModal" class="modal-upload-remaster" style="display:none;">
    <div class="modal-content-remaster">
      <h3>Upload de Arquivos</h3>
      <div class="upload-dropzones">
        <div id="dropEstampa" class="drop-zone-remaster"><span>Arraste ou clique para enviar Estampa</span><input type="file" id="uploadEstampaInput" accept="image/*" style="display: none;"></div>
        <div id="dropMockup" class="drop-zone-remaster"><span>Arraste ou clique para enviar Mockup</span><input type="file" id="uploadMockupInput" accept="image/*" style="display: none;"></div>
      </div>
      <button id="closeUploadModal" class="btn-cancel-upload" type="button">Cancelar</button>
    </div>
  </div>
  <div id="configModal" class="modal-info-remaster" style="display:none;">
    <div class="modal-content-remaster info-modal-large">
      <button id="closeConfigModal" class="close-x-modal" type="button" aria-label="Fechar">×</button>
      <h3>Configuração Técnica</h3>
      <div class="info-flex-row">
        <div class="miniaturas-info">
          <div class="miniatura-info-block"><span class="miniatura-label">Mockup</span><div class="miniatura-thumb" id="miniaturaMockup"></div><div class="miniatura-mockup-label" id="labelMockup"></div></div>
          <div class="miniatura-info-block"><span class="miniatura-label">Estampa</span><div class="miniatura-thumb" id="miniaturaEstampa"></div><div class="miniatura-estampa-label" id="labelEstampa"></div></div>
        </div>
        <div class="config-table-remaster" id="configTable"></div>
      </div>
      <pre id="configData" class="config-data-remaster" style="display:none;"></pre>
      <div class="modal-actions-row" style="flex-direction: column; gap: 12px; width:100%;">
    <button onclick="downloadMockup()" class="btn-primary" type="button">Baixar Mockup</button>
    <button id="baixarInfoBtn" class="btn-secundary" type="button">Baixar Info Técnica</button>

    <div id="opcoesDownloadInfo" style="display:none; margin-top: 10px; width: 100%; justify-content: space-around;">
        <button onclick="downloadInfo('pdf')" class="btn-primary" style="flex-grow:1;">PDF</button>
        <button onclick="downloadInfo('img')" class="btn-primary" style="flex-grow:1; margin-left: 10px;">Imagem</button>
        <button onclick="copyConfig()" class="btn-primary" style="flex-grow:1; margin-left: 10px;">JSON</button>
    </div>
</div>
      <button id="toggleConfigRaw" class="btn-toggle-raw" type="button">Ver JSON</button>
    </div>
  </div>
  <button id="creditosBtn" style="position:fixed;bottom:12px;left:12px;z-index:99;background:#fff2;border:1px solid #b99470;color:#783D19;padding:6px 12px;border-radius:12px;cursor:pointer;opacity:0.7;" type="button">Créditos</button>
  <div id="creditosModal" style="display:none;">
    <div style="background:#fff;border-radius:18px;padding:32px;min-width:320px;max-width:96vw;width:370px;position:relative;">
      <button id="closeCreditosModal" type="button" style="position:absolute;top:14px;right:14px;background:none;border:none;font-size:1.7rem;color:#b99470;cursor:pointer;">×</button>
      <h3 style="margin-bottom:18px;color:#783D19;font-size:1.18rem;text-align:center;">Créditos</h3>
      <div style="font-size:1.04rem;color:#5F6F52;margin-bottom:10px;text-align:center;">Pensado e desenvolvido por:<br><b>João Vitor Correia</b></div>
      <div style="text-align:center; margin-top: 16px;"><a href="https://www.linkedin.com/in/joão-vitor-correia-37b9a4176/" target="_blank" rel="noopener"><button type="button" style="background:#0a66c2;color:#fff;border:none;border-radius:8px;padding:8px 18px;font-size:1rem;cursor:pointer;">LinkedIn</button></a></div>
    </div>
  </div>

  <aside id="iaDrawer"></aside>

</div>

<script>
// =================================================================== //
//  NOVO SCRIPT PARA CONTROLE DO LAYOUT MOBILE
//  Este script é ADICIONAL e não modifica o original.
// =================================================================== //
document.addEventListener('DOMContentLoaded', function() {
    const backdrop = document.getElementById('sheet-backdrop');
    const editorPanel = document.getElementById('editor-panel');
    const itensPanel = document.getElementById('itens-panel');

    const navBtnEdit = document.getElementById('nav-btn-edit');
    const navBtnItems = document.getElementById('nav-btn-items');
    let estampasCarregadas = false; // Flag para controlar o carregamento

    const closeButtons = document.querySelectorAll('.sheet-close-btn');

    // Função para fechar todos os painéis abertos
    function closeAllSheets() {
        backdrop.classList.remove('is-open');
        editorPanel.classList.remove('is-open');
        itensPanel.classList.remove('is-open');
        // Remove a classe 'active' de todos os botões da nav
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
    }

    // Função para abrir um painel específico
    function openSheet(panel, button) {
        // Se o painel já estiver aberto, fecha tudo
        if (panel.classList.contains('is-open')) {
            closeAllSheets();
        } else {
            // Fecha qualquer outro painel antes de abrir o novo
            closeAllSheets();
            backdrop.classList.add('is-open');
            panel.classList.add('is-open');
            if (button) button.classList.add('active');
        }
    }

    // Eventos dos botões da navegação
    navBtnEdit.addEventListener('click', () => openSheet(editorPanel, navBtnEdit));
    navBtnItems.addEventListener('click', () => {
        openSheet(itensPanel, navBtnItems);
        // Apenas carrega as estampas se ainda não tiverem sido carregadas
        if (!estampasCarregadas) {
            if (typeof carregarEstampasPrincipais === 'function') {
                carregarEstampasPrincipais();
                estampasCarregadas = true;
            }
        }
    });

    // Eventos para fechar
    backdrop.addEventListener('click', closeAllSheets);
    closeButtons.forEach(btn => btn.addEventListener('click', closeAllSheets));

    // Lógica para alternar as abas dentro do painel de itens
    const tabButtons = document.querySelectorAll('#itens-panel .tab-btn-remaster');
    const compartments = document.querySelectorAll('#itens-panel .compartimentos-categorias-remaster');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove 'active' de todos os botões e compartimentos
            tabButtons.forEach(btn => btn.classList.remove('active'));
            compartments.forEach(comp => {
                comp.classList.remove('active');
            });

            // Adiciona 'active' ao botão clicado
            this.classList.add('active');

            // Mostra o compartimento correspondente
            let targetId = '';
            if (this.id === 'tabMockupsBtn') targetId = 'compartimentosMockup';
            if (this.id === 'tabEstampasBtn') targetId = 'compartimentosEstampa';
            if (this.id === 'tabTecidosBtn') targetId = 'compartimentosTecidos';

            const targetCompartment = document.getElementById(targetId);
            if (targetCompartment) {
                targetCompartment.classList.add('active');
            }
        });
    });
});
</script>

<script>
// =================================================================== //
//  SCRIPT ORIGINAL - SEM NENHUMA MODIFICAÇÃO
//  Todas as funções e lógica foram mantidas exatamente como estavam.
// =================================================================== //
// Função para buscar estampas do backend Render.com
function fetchEstampasBackend(callback) {
  fetch('https://estampas-oda7.onrender.com/estampas', {
    headers: {
      'Authorization': 'Basic ' + btoa('admin:senha123') // Troque se mudar usuário/senha do backend
    }
  })
    .then(res => {
      if (!res.ok) throw new Error('Erro ao buscar estampas');
      return res.json();
    })
    .then(data => {
      if (typeof callback === 'function') callback(data);
    })
    .catch(err => {

      alert('Erro ao carregar estampas do servidor: ' + err.message);
    });
}

// ----------------- REGUA REAL & REFERÊNCIA DINÂMICA + MARCAÇÕES -----------------
window.refCm = 0; // Valor em cm da referência atual
window.refNome = ''; // Nome do elemento referência
window.refCmDefault = 4; // Valor padrão se não houver na estampa
window.refNomeDefault = "Elemento referência";

document.addEventListener('DOMContentLoaded', function () {
  // ----------- RÉGUA VISUAL (marcação de cm e metros) -----------
  const reguaMetros = document.querySelector('.regua-metros');
  if (reguaMetros && !reguaMetros.querySelector('.regua-tick')) {
    for (let i = 0; i <= 200; i++) {
      const tick = document.createElement('span');
      tick.className = 'regua-tick';
      // 800px = 2m => cada cm = 4px
      const y = i * 4;
      tick.style.top = `${y}px`;
      if (i % 100 === 0) {
        tick.classList.add('major');
      } else if (i % 50 === 0) {
        tick.classList.add('mid');
      }
      reguaMetros.appendChild(tick);
    }
  }

  // Box de referência dinâmica
  const refCmBox = document.getElementById('refCmBox');
  const refCmNomeSpan = document.getElementById('refCmNome');
  const refCmValue = document.getElementById('refCmValue');

  // Função para atualizar o box dinâmico de referência
  window.updateRefCmBox = function updateRefCmBox() {
    const zoomSlider = document.getElementById('zoomSlider');
    if (window.refCm > 0 && refCmBox && refCmValue && refCmNomeSpan && zoomSlider) {
      const mult = parseFloat(zoomSlider.value) / 100;
      const atual = +(window.refCm * mult).toFixed(2);
      refCmBox.style.display = 'flex';
      refCmNomeSpan.textContent = window.refNome ? window.refNome + ":" : window.refNomeDefault + ":";
      refCmValue.textContent = `${atual}cm`;
      refCmBox.title = `Com zoom de ${zoomSlider.value}%, o elemento de referência (${window.refCm}cm) fica com ${atual}cm`;
    } else if (refCmBox) {
      refCmBox.style.display = 'none';
    }
  };
});

function loadHtml2Canvas(callback) {
  if (window.html2canvas) return callback();
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
  script.onload = callback;
  document.body.appendChild(script);
}
loadHtml2Canvas(() => {
  document.addEventListener('DOMContentLoaded', function () {
    const estampaBg = document.getElementById('estampaBg');
    const zoomSlider = document.getElementById('zoomSlider');
    const codigoEstampa = document.getElementById('codigoEstampa');
    const mockupImg = document.querySelector('.mockup-png');
    const configModal = document.getElementById('configModal');
    const configData = document.getElementById('configData');
    const configTable = document.getElementById('configTable');
    const showConfigBtn = document.getElementById('showConfig');
    const uploadButton = document.getElementById('uploadButton');
    const uploadModal = document.getElementById('uploadModal');
    const closeUploadModal = document.getElementById('closeUploadModal');
    const closeConfigModal = document.getElementById('closeConfigModal');
    const toggleConfigRaw = document.getElementById('toggleConfigRaw');
    const uploadEstampaInput = document.getElementById('uploadEstampaInput');
    const uploadMockupInput = document.getElementById('uploadMockupInput');
    const dropEstampa = document.getElementById('dropEstampa');
    const dropMockup = document.getElementById('dropMockup');
    const miniaturaMockup = document.getElementById('miniaturaMockup');
    const miniaturaEstampa = document.getElementById('miniaturaEstampa');
    const labelMockup = document.getElementById('labelMockup');
    const labelEstampa = document.getElementById('labelEstampa');
    const refCmBox = document.getElementById('refCmBox');
    const refCmNomeSpan = document.getElementById('refCmNome');
    const refCmValue = document.getElementById('refCmValue');
    let posX = 50;
    let posY = 50;

    // Estado para saber se é personalizado ou preset
    window.mockupState = {type: "none", url: mockupImg.src, name: "", thumb: mockupImg.src};
    window.estampaState = {type: "none", url: "", code: "", name: ""};

    // Para identificar as pré-existentes
    const presetMockups = {};
    document.querySelectorAll('#compartimentosMockup .thumbnail').forEach(t => {
      presetMockups[t.getAttribute('data-url')] = {
        name: t.getAttribute('data-name') || 'Mockup pré-definido',
        thumb: t.querySelector('img') ? t.querySelector('img').src : t.getAttribute('data-url'),
      };
    });
    const presetEstampas = {};
    document.querySelectorAll('#compartimentosEstampa .thumbnail').forEach(t => {
      presetEstampas[t.getAttribute('data-url')] = {
        name: t.getAttribute('data-name') || 'Estampa pré-definida',
        thumb: t.style.backgroundImage ? t.style.backgroundImage.replace(/^url\(["']?/, '').replace(/["']?\)$/, '') : t.getAttribute('data-url'),
        code: t.getAttribute('data-code') || ''
      };
    });

    // ----------------- ZOOM SLIDER VERTICAL (cross-browser) -----------------
    if(window.innerWidth > 900) { // Apenas no desktop
        zoomSlider.classList.add('zoom-slider-vertical');
        zoomSlider.style.writingMode = "bt-lr";
    }

    // ----------------- ZOOM SLIDER CORREÇÃO -----------------
    function updateZoom(value) {
      zoomSlider.value = value;
      estampaBg.style.backgroundSize = `${value}%`;
      if (typeof window.updateRefCmBox === "function") window.updateRefCmBox();
    }
    zoomSlider.addEventListener('input', () => updateZoom(zoomSlider.value));

    // ----------------- CLIQUE CONTINUO NO ZOOM -----------------
    let zoomInterval = null;
    function zoomChange(direction) {
      let currentZoom = parseInt(zoomSlider.value, 10);
      let nextZoom = direction > 0 ? Math.min(currentZoom + 10, 400) : Math.max(currentZoom - 10, 90);
      if (nextZoom !== currentZoom) updateZoom(nextZoom);
    }
    function startZoomChange(direction) {
      zoomChange(direction);
      zoomInterval = setInterval(() => zoomChange(direction), 90);
    }
    function stopZoomChange() {
      clearInterval(zoomInterval);
      zoomInterval = null;
    }
    document.getElementById('zoomIn').addEventListener('mousedown', () => startZoomChange(1));
    document.getElementById('zoomOut').addEventListener('mousedown', () => startZoomChange(-1));
    document.getElementById('zoomIn').addEventListener('mouseup', stopZoomChange);
    document.getElementById('zoomOut').addEventListener('mouseup', stopZoomChange);
    document.getElementById('zoomIn').addEventListener('mouseleave', stopZoomChange);
    document.getElementById('zoomOut').addEventListener('mouseleave', stopZoomChange);
    document.getElementById('zoomIn').addEventListener('touchstart', (e) => { e.preventDefault(); startZoomChange(1); });
    document.getElementById('zoomOut').addEventListener('touchstart', (e) => { e.preventDefault(); startZoomChange(-1); });
    document.getElementById('zoomIn').addEventListener('touchend', stopZoomChange);
    document.getElementById('zoomOut').addEventListener('touchend', stopZoomChange);
    document.getElementById('zoomIn').addEventListener('click', (e) => { if (!zoomInterval) zoomChange(1); });
    document.getElementById('zoomOut').addEventListener('click', (e) => { if (!zoomInterval) zoomChange(-1); });



    // --------- MODAL FLUIDO: abrir/fechar ---------
    showConfigBtn.addEventListener('click', () => {
      updateConfigModal();
      configModal.style.display = 'flex';
      setTimeout(() => configModal.querySelector('.modal-content-remaster').classList.add('animate-modal'), 1);
    });
    closeConfigModal.addEventListener('click', () => closeModal(configModal));
    function closeModal(modal) {
      const modalContent = modal.querySelector('.modal-content-remaster');
      if (modalContent) modalContent.classList.remove('animate-modal');
      setTimeout(() => { modal.style.display = 'none'; }, 210);
    }
    configModal.addEventListener('mousedown', function(e){
      if (e.target === configModal) closeModal(configModal);
    });

    uploadButton.addEventListener('click', () => {
      uploadModal.style.display = 'flex';
      setTimeout(() => uploadModal.querySelector('.modal-content-remaster').classList.add('animate-modal'), 1);
    });
    closeUploadModal.addEventListener('click', () => closeModal(uploadModal));
    uploadModal.addEventListener('mousedown', function(e){
      if (e.target === uploadModal) closeModal(uploadModal);
    });

    // --------- MODAL INFORMAÇÕES TÉCNICAS INTUITIVO -----------
    function updateConfigModal() {
      miniaturaMockup.style.backgroundImage = window.mockupState.thumb ? `url('${window.mockupState.thumb}')` : 'none';
      miniaturaEstampa.style.backgroundImage = window.estampaState.thumb ? `url('${window.estampaState.thumb}')` : 'none';

      labelMockup.textContent = window.mockupState.type === "custom" ? "Mockup personalizado do cliente" : (window.mockupState.name || "Mockup");
      labelEstampa.textContent = window.estampaState.type === "custom" ? "Estampa personalizada pelo cliente" : (window.estampaState.name || "Estampa");

      const mult = parseFloat(zoomSlider.value) / 100;
      const refCmFinal = window.refCm > 0 ? +(window.refCm * mult).toFixed(2) : null;
      const config = {
        mockup: window.mockupState.url,
        estampa: window.estampaState.url,
        zoom: zoomSlider.value,
        posX: posX,
        posY: posY,
        codigo: codigoEstampa.textContent,
        elementoReferenciaNome: window.refNome || window.refNomeDefault,
        elementoReferenciaCm: window.refCm || null,
        elementoReferenciaCmFinal: refCmFinal
      };
      configData.textContent = JSON.stringify(config, null, 2);
      configTable.innerHTML = `
        <div class="config-key">Mockup</div>
        <div class="config-value"><span style="display:inline-block;max-width:170px;overflow:auto;">${escapeHtml(labelMockup.textContent)}</span></div>
        <div class="config-key">Estampa</div>
        <div class="config-value"><span style="display:inline-block;max-width:170px;overflow:auto;">${escapeHtml(labelEstampa.textContent)}</span></div>
        <div class="config-key">Zoom</div>
        <div class="config-value">${config.zoom}%</div>
        <div class="config-key">X</div>
        <div class="config-value">${config.posX}%</div>
        <div class="config-key">Y</div>
        <div class="config-value">${config.posY}%</div>
        <div class="config-key">Código</div>
        <div class="config-value">${escapeHtml(config.codigo)}</div>
        <div class="config-key">Elemento referência</div>
        <div class="config-value">${window.refNome || window.refNomeDefault}</div>
        <div class="config-key">Valor referência (cm)</div>
        <div class="config-value">${window.refCm || "-"}</div>
        <div class="config-key">Valor referência final (cm)</div>
        <div class="config-value">${refCmFinal !== null ? refCmFinal : "-"}</div>
      `;
      configData.style.display = 'none';
      toggleConfigRaw.innerText = 'Ver JSON';

      // Atualizar modal de config para mostrar tecido selecionado
      let tecidoInfo = '';
      if (tecidoSelecionado) {
        tecidoInfo = `<div class="config-key">Tecido</div><div class="config-value">${escapeHtml(tecidoSelecionado.nome)}</div>`;
      }
      configTable.innerHTML += tecidoInfo;
    }
    toggleConfigRaw.addEventListener('click', function(){
      if (configData.style.display === 'none') {
        configData.style.display = '';
        configTable.style.display = 'none';
        toggleConfigRaw.innerText = 'Ver Tabela';
      } else {
        configData.style.display = 'none';
        configTable.style.display = '';
        toggleConfigRaw.innerText = 'Ver JSON';
      }
    });

    window.copyConfig = function () {
      const text = configData.textContent;
      navigator.clipboard.writeText(text).then(() => {
        toggleConfigRaw.innerText = "Copiado!";
        setTimeout(()=>toggleConfigRaw.innerText='Ver JSON',900)
      }).catch(err => { console.error('Erro ao copiar: ', err); });
    };
    window.downloadMockup = function () {
      setTimeout(() => {
        html2canvas(document.querySelector('.mockup-content'), {
          useCORS: true, allowTaint: true, logging: false,
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = 'mockup-personalizado.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      }, 200);
    };

    // --- PDF e Imagem de Info Técnica
    window.downloadInfo = function(type) {
      const card = document.createElement('div');
      card.style.width = "600px";
      card.style.background = "#f9ebc7";
      card.style.padding = "30px";
      card.style.fontFamily = "Inter, Arial, sans-serif";
      card.style.borderRadius = "18px";
      card.style.color = "#5F6F52";
      card.style.boxShadow = "0 2px 12px #b9947040";
      const mult = parseFloat(zoomSlider.value) / 100;
      const refCmFinal = window.refCm > 0 ? +(window.refCm * mult).toFixed(2) : null;
      let tecidoHtml = '';
      if (typeof tecidoSelecionado !== 'undefined' && tecidoSelecionado && tecidoSelecionado.nome) {
        tecidoHtml = `<div><b>Tecido:</b> ${escapeHtml(tecidoSelecionado.nome)}</div>`;
      }
      card.innerHTML = `
        <div style="display:flex;flex-direction:row;gap:30px;">
          <div>
            <div style="font-weight:bold;color:#783D19;">Mockup</div>
            <div style="background:#fff;border-radius:9px;border:2px solid #b99470;width:80px;height:80px;box-shadow:0 2px 8px #b9947033;margin:6px auto  5px auto;display:flex;align-items:center;justify-content:center;">
              <img src="${window.mockupState.thumb || window.mockupState.url}" style="max-width:76px;max-height:76px;border-radius:7px;">
            </div>
            <div style="font-size:0.98rem;text-align:center;min-height:20px;margin-bottom:2px;">${escapeHtml(labelMockup.textContent)}</div>
          </div>
          <div>
            <div style="font-weight:bold;color:#783D19;">Estampa</div>
            <div style="background:#fff;border-radius:9px;border:2px solid #b99470;width:80px;height:80px;box-shadow:0 2px 8px #b9947033;margin:6px auto 5px auto;display:flex;align-items:center;justify-content:center;">
              <img src="${window.estampaState.thumb || window.estampaState.url}" style="max-width:76px;max-height:76px;border-radius:7px;">
            </div>
            <div style="font-size:0.98rem;text-align:center;min-height:20px;margin-bottom:2px;">${escapeHtml(labelEstampa.textContent)}</div>
          </div>
        </div>
        <div style="margin-top:18px;font-size:1.04rem;">
          <div><b>Zoom:</b> ${zoomSlider.value}%</div>
          <div><b>Posição X:</b> ${posX}%</div>
          <div><b>Posição Y:</b> ${posY}%</div>
          <div><b>Código:</b> ${escapeHtml(codigoEstampa.textContent)}</div>
          <div><b>Elemento referência:</b> ${window.refNome || window.refNomeDefault}</div>
          <div><b>Valor referência (cm):</b> ${window.refCm || "-"}</div>
          <div><b>Valor referência final (cm):</b> ${refCmFinal !== null ? refCmFinal : "-"}</div>
          ${tecidoHtml}
        </div>
      `;
      document.body.appendChild(card);
      if (type === 'img') {
        html2canvas(card, {useCORS:true,backgroundColor:null}).then(canvas => {
          const link = document.createElement('a');
          link.download = 'informacao_tecnica.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
          document.body.removeChild(card);
        });
      } else if (type === 'pdf') {
        Promise.all([
            new Promise(resolve => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = resolve;
                document.head.appendChild(script);
            })
        ]).then(() => {
            html2canvas(card, {useCORS:true,backgroundColor:null}).then(canvas => {
              const doc = new window.jspdf.jsPDF({orientation:"p",unit:"px",format:[650,420]});
              const imgData = canvas.toDataURL("image/png");
              doc.addImage(imgData, "PNG", 20, 20, 560, 320);
              doc.save('informacao_tecnica.pdf');
              document.body.removeChild(card);
            });
        });
      }
    };

    // ----------------- THUMBNAILS E TABS -----------------
    // A LÓGICA DE TROCA DE ABAS FOI MOVIDA PARA O NOVO SCRIPT PARA FUNCIONAR NO NOVO LAYOUT
    const tabMockupsBtn = document.getElementById('tabMockupsBtn');
    const tabEstampasBtn = document.getElementById('tabEstampasBtn');
    const tabTecidosBtn = document.getElementById('tabTecidosBtn');
    const compartimentosMockup = document.getElementById('compartimentosMockup');
    const compartimentosEstampa = document.getElementById('compartimentosEstampa');
    const compartimentosTecidos = document.getElementById('compartimentosTecidos');

    // JS ORIGINAL para o desktop
    tabMockupsBtn.addEventListener('click', () => {
      if(window.innerWidth <= 900) return; // Ignora no mobile, pois é controlado pelo novo script
      tabMockupsBtn.classList.add('active');
      tabEstampasBtn.classList.remove('active');
      tabTecidosBtn.classList.remove('active');
      compartimentosMockup.style.display = "";
      compartimentosEstampa.style.display = "none";
      compartimentosTecidos.style.display = "none";
    });
    tabEstampasBtn.addEventListener('click', () => {
       if(window.innerWidth <= 900) return; // Ignora no mobile
      tabEstampasBtn.classList.add('active');
      tabMockupsBtn.classList.remove('active');
      tabTecidosBtn.classList.remove('active');
      compartimentosMockup.style.display = "none";
      compartimentosEstampa.style.display = "";
      compartimentosTecidos.style.display = "none";
      // Atualiza as thumbnails de estampas sempre que a aba for ativada
      carregarEstampasPrincipais();
    });
    tabTecidosBtn.addEventListener('click', () => {
       if(window.innerWidth <= 900) return; // Ignora no mobile
      tabTecidosBtn.classList.add('active');
      tabMockupsBtn.classList.remove('active');
      tabEstampasBtn.classList.remove('active');
      compartimentosMockup.style.display = "none";
      compartimentosEstampa.style.display = "none";
      compartimentosTecidos.style.display = "";
    });

    // Tecidos: seleção e estado
    let tecidoSelecionado = null;
    document.body.addEventListener('click', function(e) {
        if (e.target.matches('.tecido-thumbnail')) {
            document.querySelectorAll('.tecido-thumbnail.selected').forEach(el => el.classList.remove('selected'));
            e.target.classList.add('selected');
            tecidoSelecionado = {
              nome: e.target.getAttribute('data-nome'),
              id: e.target.getAttribute('data-id'),
              thumb: e.target.style.backgroundImage.replace(/^url\(["']?/, '').replace(/["']?\)$/, '')
            };
        }
    });

    // Drag and drop upload
    function handleEstampaFiles(files) {
      const arquivo = files[0];
      if (arquivo) {
        const reader = new FileReader();
        reader.onload = function(e) {
          estampaBg.style.backgroundImage = `url(${e.target.result})`;
          estampaBg.style.backgroundSize = `${zoomSlider.value}%`;
          estampaBg.style.backgroundPosition = `${posX}% ${posY}%`;
          window.estampaState = {
            type: "custom",
            url: e.target.result,
            code: "",
            name: "",
            thumb: e.target.result
          };
          window.refCm = window.refCmDefault;
          window.refNome = window.refNomeDefault;
          if (typeof window.updateRefCmBox === "function") window.updateRefCmBox();
        };
        reader.readAsDataURL(arquivo);
      }
      closeModal(uploadModal);
    }
    dropEstampa.addEventListener('click', () => uploadEstampaInput.click());
    dropEstampa.addEventListener('dragover', (e) => { e.preventDefault(); dropEstampa.classList.add('dragover'); });
    dropEstampa.addEventListener('dragleave', (e) => dropEstampa.classList.remove('dragover'));
    dropEstampa.addEventListener('drop', (e) => {
      e.preventDefault(); dropEstampa.classList.remove('dragover');
      if (e.dataTransfer.files.length) handleEstampaFiles(e.dataTransfer.files);
    });
    uploadEstampaInput.addEventListener('change', (event) => handleEstampaFiles(event.target.files));

    function handleMockupFiles(files) {
      const arquivo = files[0];
      if (arquivo) {
        const reader = new FileReader();
        reader.onload = function(e) {
          mockupImg.src = e.target.result;
          window.mockupState = {
            type: "custom",
            url: e.target.result,
            name: "",
            thumb: e.target.result
          };
        };
        reader.readAsDataURL(arquivo);
      }
      closeModal(uploadModal);
    }
    dropMockup.addEventListener('click', () => uploadMockupInput.click());
    dropMockup.addEventListener('dragover', (e) => { e.preventDefault(); dropMockup.classList.add('dragover'); });
    dropMockup.addEventListener('dragleave', (e) => dropMockup.classList.remove('dragover'));
    dropMockup.addEventListener('drop', (e) => {
      e.preventDefault(); dropMockup.classList.remove('dragover');
      if (e.dataTransfer.files.length) handleMockupFiles(e.dataTransfer.files);
    });
    uploadMockupInput.addEventListener('change', (event) => handleMockupFiles(event.target.files));

    // ----------------- JOYSTICK -----------------
    const joystickHandle = document.getElementById('joystickHandle');
    const joystickBase = document.getElementById('joystickBase');
    let isDragging = false;
    joystickHandle.addEventListener('mousedown', (e) => {
      isDragging = true;
      joystickHandle.style.cursor = 'grabbing';
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', onDragEnd);
    });
    joystickHandle.addEventListener('touchstart', (e) => {
        isDragging = true;
        document.addEventListener('touchmove', onDrag, { passive: false });
        document.addEventListener('touchend', onDragEnd);
    });

    function onDragEnd() {
        isDragging = false;
        joystickHandle.style.cursor = 'grab';
        joystickHandle.style.transition = 'top 0.2s, left 0.2s';
        joystickHandle.style.left = `calc(50% - ${joystickHandle.offsetWidth / 2}px)`;
        joystickHandle.style.top = `calc(50% - ${joystickHandle.offsetHeight / 2}px)`;
        setTimeout(() => { joystickHandle.style.transition = ''; }, 200);

        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchmove', onDrag);
        document.removeEventListener('touchend', onDragEnd);
    }

    function onDrag(e) {
      if (!isDragging) return;
      e.preventDefault();

      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;

      const rect = joystickBase.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const deltaX = clientX - centerX;
      const deltaY = clientY - centerY;

      const distance = Math.min(rect.width / 2, Math.sqrt(deltaX*deltaX + deltaY*deltaY));
      const angle = Math.atan2(deltaY, deltaX);

      const handleX = distance * Math.cos(angle);
      const handleY = distance * Math.sin(angle);

      posX += (handleX / (rect.width / 2)) * 2;
      posY += (handleY / (rect.height / 2)) * 2;
      posX = Math.max(0, Math.min(100, posX));
      posY = Math.max(0, Math.min(100, posY));
      estampaBg.style.backgroundPosition = `${posX}% ${posY}%`;

      joystickHandle.style.left = `calc(50% - ${joystickHandle.offsetWidth / 2}px + ${handleX}px)`;
      joystickHandle.style.top = `calc(50% - ${joystickHandle.offsetHeight / 2}px + ${handleY}px)`;
    }

    // Inicializa com padrão (primeira carga)
    window.refCm = window.refCmDefault;
    window.refNome = window.refNomeDefault;
    if (typeof window.updateRefCmBox === "function") window.updateRefCmBox();

    // Seleção de mockup e estampa via delegação de eventos para funcionar com conteúdo dinâmico
    document.body.addEventListener('click', function(e) {
        const thumbnail = e.target.closest('.thumbnail');
        if (!thumbnail) return;

        // Seleção de Mockup
        if (thumbnail.closest('#compartimentosMockup')) {
            document.querySelectorAll('#compartimentosMockup .thumbnail.selected').forEach(el => el.classList.remove('selected'));
            thumbnail.classList.add('selected');
            const url = thumbnail.getAttribute('data-url');
            const name = thumbnail.getAttribute('data-name') || 'Mockup';
            const thumb = thumbnail.querySelector('img') ? thumbnail.querySelector('img').src : url;
            mockupImg.src = url;
            window.mockupState = { type: 'preset', url, name, thumb };
        }

        // Seleção de Estampa
        if (thumbnail.closest('#compartimentosEstampa')) {
            document.querySelectorAll('#compartimentosEstampa .thumbnail.selected').forEach(el => el.classList.remove('selected'));
            thumbnail.classList.add('selected');
            const url = thumbnail.getAttribute('data-url');
            const name = thumbnail.getAttribute('data-name') || 'Estampa';
            const code = thumbnail.getAttribute('data-code') || '';
            const thumb = url; // Simplificado
            estampaBg.style.backgroundImage = `url('${url}')`;
            estampaBg.style.backgroundSize = `${zoomSlider.value}%`;
            estampaBg.style.backgroundPosition = `${posX}% ${posY}%`;
            window.estampaState = { type: 'preset', url, code, name, thumb };
            if (codigoEstampa) codigoEstampa.textContent = code || 'Código da Estampa';
            window.refCm = parseFloat(thumbnail.getAttribute('data-refcm')) || window.refCmDefault;
            window.refNome = thumbnail.getAttribute('data-refnome') || window.refNomeDefault;
            if (typeof window.updateRefCmBox === "function") window.updateRefCmBox();
        }

        if (typeof updateConfigModal === 'function') updateConfigModal();
    });
  });
});

// Este script adiciona um botão "Enviar Configurações" ao modal de "Copiar Config".
// Permite ao usuário enviar a informação técnica (PDF ou imagem + mockup) para um e-mail ou WhatsApp pré-configurado.
// Requer html2canvas e jsPDF já carregados (como no código base).
const EMAIL_DESTINO = "administrador@estudiodeestampamj.com";  // Troque para o e-mail desejado
const WHATSAPP_NUMERO = "5515991876055"; // Somente números com DDI/DDD. Exemplo: 5511999999999
document.addEventListener('DOMContentLoaded', function () {
  const sendConfigBtn = document.getElementById("sendConfigBtn");
  if (sendConfigBtn) {
    sendConfigBtn.onclick = showSendConfigDialog;
  }
});
function showSendConfigDialog() {
  if (document.getElementById('sendConfigDialog')) return;
  const dialog = document.createElement('div');
  dialog.id = 'sendConfigDialog';
  dialog.style.position = 'fixed';
  dialog.style.left = '0';
  dialog.style.right = '0';
  dialog.style.top = '0';
  dialog.style.bottom = '0';
  dialog.style.background = 'rgba(0,0,0,0.12)';
  dialog.style.zIndex = '99999';
  dialog.style.display = 'flex';
  dialog.style.alignItems = 'center';
  dialog.style.justifyContent = 'center';
  dialog.innerHTML = `
    <div style="background:#fff;border-radius:16px;box-shadow:0 8px 32px #0002;padding:33px 28px 18px 28px;display:flex;flex-direction:column;align-items:center;min-width:320px;">
      <h3 style="margin:0 0 15px 0;font-size:1.12rem;color:#783D19;">Enviar Configurações</h3>
      <div style="display:flex;flex-direction:column;gap:12px;width:100%;">
        <button id="sendConfigMail" class="btn-primary" style="width:100%;max-width:210px;">Enviar por E-mail</button>
        <button id="sendConfigWhats" class="btn-primary" style="width:100%;max-width:210px;">Enviar por WhatsApp</button>
        <button id="sendConfigCancel" class="btn-cancel-upload" style="margin-top:10px;width:100%;max-width:210px;">Cancelar</button>
      </div>
    </div>
  `;
  document.body.appendChild(dialog);
  document.getElementById('sendConfigMail').onclick = () => { dialog.remove(); sendConfigVia('mail'); };
  document.getElementById('sendConfigWhats').onclick = () => { dialog.remove(); sendConfigVia('whatsapp'); };
  document.getElementById('sendConfigCancel').onclick = () => dialog.remove();
}
function sendConfigVia(destino) { /* Função original mantida */ }
function abrirModalImagemGrande(src) { /* Função original mantida */ }
function escapeHtml(str) { if (!str) return ''; return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;"); }
function carregarEstampasPrincipais() {
  const compartimentosEstampa = document.getElementById('compartimentosEstampa');
  if (!compartimentosEstampa) return;

  // Mostra um feedback visual de carregamento para o usuário
  compartimentosEstampa.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--cor-primaria); font-weight: bold;">Carregando estampas...</div>';

  fetchEstampasBackend(function(json) {
    window.estampasJson = json;

    // Limpa o feedback de carregamento
    compartimentosEstampa.innerHTML = '';

    estampasJson.categorias.forEach(cat => {
      const catDiv = document.createElement('div');
      catDiv.className = 'categoria-box-remaster';
      catDiv.innerHTML = `<div class="categoria-title-remaster">${cat.icone || ''} ${cat.nome}</div>`;
      const thumbsDiv = document.createElement('div');
      thumbsDiv.className = 'categoria-thumbnails-remaster';
      cat.estampas.forEach(est => {
        const thumb = document.createElement('div');
        thumb.className = 'thumbnail';
        thumb.setAttribute('data-url', est.url);
        thumb.setAttribute('data-code', est.code || '');
        thumb.setAttribute('data-type', 'preset');
        thumb.setAttribute('data-name', est.name || '');
        thumb.setAttribute('data-refcm', est.refcm || '');
        thumb.setAttribute('data-refnome', est.refnome || '');
        const img = document.createElement('img');
        img.src = est.url;
        img.className = 'estampa-circle';
        img.alt = est.name || 'Estampa';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        thumb.appendChild(img);
        thumbsDiv.appendChild(thumb);
      });
      catDiv.appendChild(thumbsDiv);
      compartimentosEstampa.appendChild(catDiv);
    });
    renderWatermarkOverlay();
  });
}
function renderWatermarkOverlay() { /* Função original mantida */ }
carregarEstampasPrincipais();

// --- INÍCIO DO BLOCO ÚNICO DO CHAT IA --- (Lógica interna mantida)
if (!document.getElementById('iaDrawer').innerHTML) {
  const iaDrawer = document.getElementById('iaDrawer');
  iaDrawer.innerHTML = `
    <div class="ia-drawer-main">
      <div class="ia-drawer-header">
        <div class="ia-avatar ia-avatar-lg">🤖</div>
        <div class="ia-drawer-title">
          <h3>Mockup Creator - Nick</h3>
          <span>Powered by ArtenzaStudio</span>
        </div>
        <button id="closeIaDrawer" title="Fechar">×</button>
      </div>
      <div id="iaDrawerChat" class="ia-drawer-chat"></div>
      <form id="iaDrawerForm" class="ia-drawer-form">
        <label for="iaDrawerImageInput" id="iaDrawerAddImageBtn">
          <svg width="22" height="22" fill="none" stroke="#783D19" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
          <input type="file" id="iaDrawerImageInput" accept="image/*" style="display:none;">
        </label>
        <textarea id="iaDrawerPrompt" placeholder="Digite sua mensagem..."></textarea>
        <button id="iaDrawerEnviarBtn" type="submit">Enviar</button>
      </form>
    </div>
  `;
}
const abrirIaBtn = document.getElementById('abrirIaBtn');
const iaBalloonTip = document.getElementById('iaBalloonTip');
if (abrirIaBtn && iaBalloonTip) {
  setTimeout(() => {
    const btnRect = abrirIaBtn.getBoundingClientRect();
    iaBalloonTip.style.top = (btnRect.top - iaBalloonTip.offsetHeight - 10) + "px";
    iaBalloonTip.style.left = (btnRect.left + (btnRect.width / 2) - (iaBalloonTip.offsetWidth / 2)) + "px";
    iaBalloonTip.style.display = "block";
    let balloonTimeout = setTimeout(() => iaBalloonTip.style.display = "none", 8000);
    abrirIaBtn.addEventListener('click', () => { iaBalloonTip.style.display = "none"; clearTimeout(balloonTimeout); });
    iaBalloonTip.addEventListener('click', () => { iaBalloonTip.style.display = "none"; clearTimeout(balloonTimeout); });
  }, 8000);
}
const iaDrawer = document.getElementById('iaDrawer');
const closeIaDrawer = document.getElementById('closeIaDrawer');
if (abrirIaBtn && iaDrawer) {
  abrirIaBtn.onclick = () => { iaDrawer.classList.add('open'); renderIaDrawerChat(); };
}
if (closeIaDrawer && iaDrawer) {
  closeIaDrawer.onclick = () => iaDrawer.classList.remove('open');
}
let iaChatHistory = [];
let iaImageBase64 = null;
function renderIaDrawerChat() { /* Função original mantida */ }
const iaDrawerForm = document.getElementById('iaDrawerForm');
const iaDrawerPrompt = document.getElementById('iaDrawerPrompt');
const iaDrawerImageInput = document.getElementById('iaDrawerImageInput');
if (iaDrawerForm) {
  iaDrawerForm.onsubmit = async function(e) {
    e.preventDefault();
    const prompt = iaDrawerPrompt.value.trim();
    if (!prompt && !iaImageBase64) return;
    const imageToSend = iaImageBase64;
    iaChatHistory.push({ role: 'user', text: prompt, image: imageToSend ? imageToSend : null });
    renderIaDrawerChat();
    iaDrawerPrompt.value = '';
    iaImageBase64 = null;
    document.getElementById('iaDrawerAddImageBtn').classList.remove('selected');
    iaChatHistory.push({ role: 'ia', text: 'Aguarde resposta da IA...', image: null });
    renderIaDrawerChat();
    fetch('https://estampas-oda7.onrender.com/dalle', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, image: imageToSend })
    })
    .then(res => res.json())
    .then(data => {
      iaChatHistory.pop(); // Remove "Aguarde..."
      iaChatHistory.push({ role: 'ia', text: data.output, image: data.image || null });
      renderIaDrawerChat();
    })
    .catch(err => {
      iaChatHistory.pop();
      iaChatHistory.push({ role: 'ia', text: 'Erro: ' + err.message, image: null });
      renderIaDrawerChat();
    });
  };
}
if (iaDrawerImageInput) {
    iaDrawerImageInput.onchange = async function(e) {
    if (iaDrawerImageInput.files && iaDrawerImageInput.files[0]) {
      const file = iaDrawerImageInput.files[0];
      iaImageBase64 = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
      document.getElementById('iaDrawerAddImageBtn').classList.add('selected');
    } else {
      iaImageBase64 = null;
      document.getElementById('iaDrawerAddImageBtn').classList.remove('selected');
    }
  };
}

// --- FIM DO BLOCO ÚNICO DO CHAT IA ---
// Mostrar/ocultar modal de créditos
document.addEventListener('DOMContentLoaded', function () {
  const creditosBtn = document.getElementById('creditosBtn');
  const creditosModal = document.getElementById('creditosModal');
  const closeCreditosModal = document.getElementById('closeCreditosModal');
  if (creditosBtn && creditosModal) { creditosBtn.onclick = () => { creditosModal.style.display = 'flex'; }; }
  if (closeCreditosModal && creditosModal) {
    closeCreditosModal.onclick = () => { creditosModal.style.display = 'none'; };
    creditosModal.addEventListener('mousedown', function(e){ if (e.target === creditosModal) creditosModal.style.display = 'none'; });
  }
  // Lógica para o novo botão de download de informações
    const baixarInfoBtn = document.getElementById('baixarInfoBtn');
    if (baixarInfoBtn) {
        baixarInfoBtn.addEventListener('click', function() {
            const opcoes = document.getElementById('opcoesDownloadInfo');
            if (opcoes) {
                const isHidden = opcoes.style.display === 'none';
                opcoes.style.display = isHidden ? 'flex' : 'none';
            }
        });
    }
});
</script>
</body>
</html>
