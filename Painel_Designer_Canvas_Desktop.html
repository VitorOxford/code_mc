<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MockupCreator Pro - Canvas Edition</title>
    <style>
        :root {
            --cor-fundo-workspace: #2a2a2e;
            --cor-fundo-paineis: #1e1e1e;
            --cor-fundo-elementos: #3c3c3e;
            --cor-borda-sutil: #4a4a4c;
            --cor-borda-forte: #6a6a6c;
            --cor-acento-primario: #B99470;
            --cor-acento-secundario: #783D19;
            --cor-verde-acao: #25D366;
            --cor-texto-principal: #f0f0f0;
            --cor-texto-secundario: #a0a0a0;
            --cor-texto-inverso: #1e1e1e;
            --cor-vidro: rgba(42, 42, 46, 0.7);
            --cor-vidro-borda: rgba(185, 148, 112, 0.5);
            --largura-ferramentas: 56px;
            --largura-ativos: 300px;
            --altura-header: 50px;
            --raio-borda: 10px;
            --fonte-principal: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        html, body {
            width: 100%; height: 100%;
            font-family: var(--fonte-principal);
            background-color: var(--cor-fundo-paineis);
            color: var(--cor-texto-principal);
        }

        .workspace-wrapper { display: grid; grid-template-rows: var(--altura-header) 1fr; grid-template-columns: 100%; width: 100%; height: 100%; }
        
        .workspace-header {
            grid-row: 1 / 2; display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; background-color: var(--cor-fundo-paineis);
            border-bottom: 1px solid var(--cor-borda-sutil); z-index: 10;
        }
        
        .header-group { display: flex; align-items: center; gap: 16px; }
        .logo { font-weight: 700; font-size: 1.1rem; color: var(--cor-acento-primario); }
        .codigo-estampa {
            font-size: 0.85rem; font-weight: 500; background-color: var(--cor-fundo-elementos);
            color: var(--cor-texto-secundario); padding: 6px 12px;
            border-radius: var(--raio-borda); border: 1px solid var(--cor-borda-sutil);
        }

        .header-button {
            background: none; border: 1px solid transparent; padding: 6px 14px;
            font-size: 0.85rem; font-weight: 600; color: var(--cor-texto-secundario);
            cursor: pointer; border-radius: 8px; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 8px;
        }
        .header-button:hover { background-color: var(--cor-fundo-elementos); color: var(--cor-texto-principal); }
        .header-button.primary { background-color: var(--cor-acento-primario); color: var(--cor-texto-inverso); }
        .header-button.primary:hover { background-color: var(--cor-acento-secundario); color: var(--cor-texto-principal); }
        .header-button.cta { background-color: var(--cor-verde-acao); color: var(--cor-texto-inverso); font-weight: 700; }
        .header-button.cta:hover { background-color: #2fdd70; }
        .header-button svg { width: 16px; height: 16px; }

        .workspace-main {
            grid-row: 2 / 3; display: grid;
            grid-template-columns: var(--largura-ferramentas) minmax(0, 1fr) var(--largura-ativos);
            overflow: hidden;
        }

        .tools-sidebar {
            grid-column: 1 / 2; background-color: var(--cor-fundo-paineis);
            border-right: 1px solid var(--cor-borda-sutil); padding: 12px 0;
            display: flex; flex-direction: column; align-items: center;
            gap: 8px; z-index: 20;
        }

        .tool-button {
            background: none; border: none; width: 40px; height: 40px;
            border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            color: var(--cor-texto-secundario);
            transition: all 0.2s ease; position: relative;
        }
        .tool-button:hover { background-color: var(--cor-fundo-elementos); color: var(--cor-texto-principal); }
        .tool-button.active { background-color: var(--cor-acento-primario); color: var(--cor-texto-inverso); }
        .tool-button svg { width: 22px; height: 22px; }
        
        .tool-popup {
            position: absolute; left: calc(var(--largura-ferramentas) + 10px);
            background-color: var(--cor-vidro);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--cor-vidro-borda); border-radius: var(--raio-borda);
            padding: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 15; display: none; flex-direction: column; gap: 12px;
            min-width: 240px; animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .tool-popup.show { display: flex; }
        .popup-label { font-size: 0.75rem; font-weight: 600; color: var(--cor-texto-secundario); text-transform: uppercase; letter-spacing: 0.5px; }
        .popup-controls { display: flex; align-items: center; gap: 8px; }
        .popup-controls input[type="range"] { flex-grow: 1; accent-color: var(--cor-acento-primario); }
        .popup-controls .quick-btn {
            background-color: var(--cor-fundo-elementos); border: 1px solid var(--cor-borda-sutil);
            color: var(--cor-texto-principal); width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; font-size: 1rem; font-weight: bold;
        }
        .joystick-base { width: 120px; height: 120px; border: 2px solid var(--cor-borda-sutil); background: var(--cor-fundo-paineis); border-radius: 50%; position: relative; align-self: center; }
        .joystick-handle { width: 40px; height: 40px; background: var(--cor-acento-primario); border-radius: 50%; position: absolute; top: calc(50% - 20px); left: calc(50% - 20px); cursor: grab; border: 3px solid var(--cor-fundo-paineis); box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        .canvas-area {
            grid-column: 2 / 3; background-color: var(--cor-fundo-workspace);
            display: grid; grid-template-columns: 30px 1fr;
            grid-template-rows: 30px 1fr; overflow: hidden;
            position: relative;
        }
        
        .ruler {
            background-color: var(--cor-fundo-paineis);
            position: relative; overflow: hidden;
            z-index: 5; user-select: none;
        }
        .ruler.horizontal { grid-column: 2 / 3; grid-row: 1 / 2; border-bottom: 1px solid var(--cor-borda-sutil); }
        .ruler.vertical { grid-column: 1 / 2; grid-row: 2 / 3; border-right: 1px solid var(--cor-borda-sutil); }
        .ruler .tick { position: absolute; background-color: var(--cor-borda-forte); }
        .ruler.horizontal .tick { width: 1px; height: 100%; top: 0; }
        .ruler.horizontal .tick.major { height: 70%; background-color: var(--cor-acento-primario); }
        .ruler.horizontal .tick.medium { height: 40%; }
        .ruler.horizontal .tick.minor { height: 20%; }
        .ruler.vertical .tick { width: 100%; height: 1px; left: 0; }
        .ruler.vertical .tick.major { width: 70%; background-color: var(--cor-acento-primario); }
        .ruler.vertical .tick.medium { width: 40%; }
        .ruler.vertical .tick.minor { width: 20%; }
        .ruler .label { position: absolute; font-size: 10px; color: var(--cor-texto-secundario); }
        .ruler.horizontal .label { top: 2px; transform: translateX(4px); }
        .ruler.vertical .label { left: 2px; transform: translateY(8px); writing-mode: vertical-rl; }

        .canvas-wrapper {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow: hidden;
        }
        
        #mainCanvas {
            box-shadow: 0 10px 50px rgba(0,0,0,0.2);
            background-color: #fff;
            border-radius: var(--raio-borda);
        }

        .ref-cm-box {
            position: absolute; left: 15px; top: 15px;
            background: var(--cor-vidro); color: var(--cor-texto-principal);
            border: 1px solid var(--cor-vidro-borda); border-radius: 8px;
            font-size: 0.8rem; padding: 5px 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 3; display: none; align-items: center; gap: 5px; backdrop-filter: blur(4px);
        }
        
        .assets-sidebar {
            grid-column: 3 / 4; background-color: var(--cor-fundo-paineis);
            border-left: 1px solid var(--cor-borda-sutil); display: flex;
            flex-direction: column; z-index: 5; position: relative;
        }
        .assets-header { padding: 8px; border-bottom: 1px solid var(--cor-borda-sutil); }
        .search-bar {
            width: 100%; padding: 8px 12px; border-radius: 8px;
            border: 1px solid var(--cor-borda-sutil);
            background-color: var(--cor-fundo-elementos);
            color: var(--cor-texto-principal); font-size: 0.9rem;
        }
        .search-bar:focus { outline: none; border-color: var(--cor-acento-primario); box-shadow: 0 0 0 2px var(--cor-acento-secundario); }

        .assets-tabs { display: flex; border-bottom: 1px solid var(--cor-borda-sutil); }
        .tab-btn {
            flex: 1; background: none; border: none; padding: 10px 8px;
            font-size: 0.85rem; font-weight: 600; color: var(--cor-texto-secundario);
            cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s ease;
        }
        .tab-btn:hover { color: var(--cor-texto-principal); }
        .tab-btn.active { color: var(--cor-acento-primario); border-bottom-color: var(--cor-acento-primario); }

        .assets-content { flex-grow: 1; overflow-y: auto; padding: 16px; }
        .compartimento-assets { display: none; flex-direction: column; gap: 24px; }
        .compartimento-assets.active { display: flex; }
        .categoria-box { display: flex; flex-direction: column; gap: 12px; }
        .categoria-title-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .categoria-title { font-size: 0.9rem; font-weight: 700; color: var(--cor-texto-principal); }
        .btn-expand-categoria {
            background: none; border: none; color: var(--cor-texto-secundario); cursor: pointer;
            width: 24px; height: 24px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .btn-expand-categoria:hover { background-color: var(--cor-fundo-elementos); }
        .categoria-thumbnails { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 12px; }
        .thumbnail {
            aspect-ratio: 1 / 1; border-radius: var(--raio-borda);
            background-color: var(--cor-fundo-elementos); background-size: cover; background-position: center;
            cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease; overflow: hidden;
        }
        .thumbnail:hover { transform: scale(1.05); border-color: var(--cor-acento-secundario); }
        .thumbnail.selected { border-color: var(--cor-acento-primario); transform: scale(1.05); }

        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(10, 10, 10, 0.7); backdrop-filter: blur(5px);
            z-index: 1000; display: none; align-items: center; justify-content: center;
            animation: fadeIn 0.3s;
        }
        .modal-backdrop.show { display: flex; }
    </style>
</head>
<body>

    <div class="workspace-wrapper">
        <header class="workspace-header">
            <div class="header-group">
                <span class="logo">MockupCreator</span>
                <div id="codigoEstampa" class="codigo-estampa">Nenhuma estampa</div>
            </div>
            <div class="header-group">
                <button type="button" id="creditosBtn" class="header-button">Créditos</button>
                <button type="button" id="abrirIaBtn" class="header-button">Assistente IA</button>
                <button type="button" id="falarRepresentanteBtn" class="header-button cta">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    Fazer Pedido
                </button>
                <button type="button" id="showConfig" class="header-button primary">Exportar</button>
            </div>
        </header>
    
        <main class="workspace-main">
            <aside class="tools-sidebar">
                <button type="button" class="tool-button" data-tooltip="Mover" data-tool="move">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 9l-3 3 3 3"/><path d="M9 5l3-3 3 3"/><path d="M15 19l-3 3-3-3"/><path d="M19 9l3 3-3 3"/><path d="M2 12h20"/><path d="M12 2v20"/></svg>
                </button>
                <button type="button" class="tool-button" data-tooltip="Zoom" data-tool="zoom">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                </button>
                <button type="button" class="tool-button" data-tooltip="Girar" data-tool="rotate">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M15.52 6.48a9 9 0 0 0-12.04 0M2.5 12.5a9 9 0 0 0 19.04-2.5"/></svg>
                </button>
                <button type="button" id="uploadButton" class="tool-button" data-tooltip="Upload">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </button>
            </aside>
    
            <div id="popup-move" class="tool-popup" data-tool-popup="move">
                <span class="popup-label">Mover Estampa</span>
                <div id="joystickBase" class="joystick-base">
                    <div id="joystickHandle" class="joystick-handle"></div>
                </div>
            </div>
            <div id="popup-zoom" class="tool-popup" data-tool-popup="zoom">
                <span class="popup-label">Zoom da Estampa</span>
                <div class="popup-controls">
                    <input type="range" id="zoomSlider" min="10" max="400" value="100" step="1">
                </div>
            </div>
            <div id="popup-rotate" class="tool-popup" data-tool-popup="rotate">
                <span class="popup-label">Girar Estampa</span>
                <div class="popup-controls">
                    <button type="button" id="rotateLeftBtn" class="quick-btn">↺</button>
                    <input type="range" id="rotationSlider" min="0" max="360" value="0" step="1">
                    <button type="button" id="rotateRightBtn" class="quick-btn">↻</button>
                </div>
            </div>
    
            <div class="canvas-area">
                <div class="ruler horizontal" id="ruler-horizontal"></div>
                <div class="ruler vertical" id="ruler-vertical"></div>
                
                <div class="canvas-wrapper">
                    <canvas id="mainCanvas" width="700" height="800"></canvas>
                </div>
            </div>
    
            <aside class="assets-sidebar">
                <div class="assets-header">
                    <input type="search" id="assetSearch" class="search-bar" placeholder="Buscar ativos...">
                </div>
                <div class="assets-tabs">
                    <button type="button" class="tab-btn active" data-tab="mockups">Mockups</button>
                    <button type="button" class="tab-btn" data-tab="estampas">Estampas</button>
                    <button type="button" class="tab-btn" data-tab="tecidos">Tecidos</button>
                </div>
                <div class="assets-content">
                    <div id="compartimento-mockups" class="compartimento-assets active"></div>
                    <div id="compartimento-estampas" class="compartimento-assets"></div>
                    <div id="compartimento-tecidos" class="compartimento-assets"></div>
                </div>
            </aside>
        </main>
    </div>
    
    <script>
document.addEventListener('DOMContentLoaded', () => {

    // --- NOVA ESTRUTURA: Referência ao Canvas ---
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');

    const codigoEstampaEl = document.getElementById('codigoEstampa');
    const rulerH = document.getElementById('ruler-horizontal');
    const rulerV = document.getElementById('ruler-vertical');
    const zoomSlider = document.getElementById('zoomSlider');
    const rotationSlider = document.getElementById('rotationSlider');
    const joystickHandle = document.getElementById('joystickHandle');
    const joystickBase = document.getElementById('joystickBase');

    const DPI_PADRAO = 96;
    
    // --- NOVA ESTRUTURA: State com sistema de camadas ---
    let state = {
        layers: [
            // Camada 0: Estampa/Textura
            {
                type: 'estampa',
                image: null, // Objeto Image() carregado
                source: null, // URL da imagem
                visible: true,
                posX: 0, // Posição X no canvas
                posY: 0, // Posição Y no canvas
                zoom: 1.0, // Escala (1.0 = 100%)
                rotation: 0, // Rotação em radianos
            },
            // Camada 1: Mockup (desenhado por cima)
            {
                type: 'mockup',
                image: null,
                source: 'https://cdn.shopify.com/s/files/1/0661/4574/6991/files/mockup_experimental_1.png?v=1746646882',
                visible: true,
                posX: 0,
                posY: 0,
                zoom: 1.0,
                rotation: 0
            }
        ],
        isDragging: false, 
        activeTool: null,
        rulerMaxCmW: 100,
        rulerMaxCmH: 100
    };
    
    // --- NOVA ESTRUTURA: Loop de Renderização Principal ---
    function renderCanvas() {
        if (!canvas || !ctx) return;

        // Limpa o canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Desenha cada camada
        state.layers.forEach(layer => {
            if (!layer.visible || !layer.image) return;

            ctx.save(); // Salva o estado atual do canvas

            // Calcula o centro do canvas para rotação e escala
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            // 1. Translada para o centro
            ctx.translate(centerX, centerY);
            // 2. Rotaciona
            ctx.rotate(layer.rotation);
            // 3. Escala
            ctx.scale(layer.zoom, layer.zoom);
            // 4. Translada de volta
            ctx.translate(-centerX, -centerY);

            // Calcula a posição para desenhar a imagem, aplicando o pan (posX, posY)
            // e centralizando a imagem
            const drawX = layer.posX + (canvas.width - layer.image.width) / 2;
            const drawY = layer.posY + (canvas.height - layer.image.height) / 2;

            ctx.drawImage(layer.image, drawX, drawY);

            ctx.restore(); // Restaura o estado do canvas para a próxima camada
        });
    }

    // --- NOVA ESTRUTURA: Função para carregar uma imagem em uma camada ---
    function loadImageForLayer(layerIndex, url, callback) {
        const layer = state.layers[layerIndex];
        if (!url) {
            layer.image = null;
            layer.source = null;
            renderCanvas();
            if (callback) callback();
            return;
        }

        const img = new Image();
        img.crossOrigin = "Anonymous"; // Permite carregar imagens de outras origens
        img.src = url;
        img.onload = () => {
            layer.image = img;
            layer.source = url;
            renderCanvas(); // Redesenha com a nova imagem
            if (callback) callback(img);
        };
        img.onerror = () => {
            console.error(`Falha ao carregar a imagem: ${url}`);
        };
    }


    const toolButtons = document.querySelectorAll('.tool-button');
    toolButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            // A lógica dos botões agora deve atualizar o estado e chamar renderCanvas()
            const toolName = button.dataset.tool;
            if (toolName === 'toggle-mockup') {
                const mockupLayer = state.layers.find(l => l.type === 'mockup');
                if(mockupLayer) {
                    mockupLayer.visible = !mockupLayer.visible;
                    renderCanvas();
                }
            }
             // Lógica de outras ferramentas...
        });
    });

    // --- Lógica de Controles Adaptada para Canvas ---
    zoomSlider.addEventListener('input', (e) => {
        const estampaLayer = state.layers.find(l => l.type === 'estampa');
        if (estampaLayer) {
            estampaLayer.zoom = parseFloat(e.target.value) / 100;
            renderCanvas();
        }
    });

    rotationSlider.addEventListener('input', (e) => {
        const estampaLayer = state.layers.find(l => l.type === 'estampa');
        if (estampaLayer) {
            // Converte graus para radianos para o canvas
            estampaLayer.rotation = parseFloat(e.target.value) * (Math.PI / 180);
            renderCanvas();
        }
    });

    joystickHandle.addEventListener('mousedown', () => { state.isDragging = true; });
    document.addEventListener('mouseup', () => { state.isDragging = false; });
    document.addEventListener('mousemove', (e) => {
        if (!state.isDragging) return;
        
        const estampaLayer = state.layers.find(l => l.type === 'estampa');
        if (!estampaLayer) return;

        // Lógica simplificada do joystick para translação
        const baseRect = joystickBase.getBoundingClientRect();
        const centerX = baseRect.left + baseRect.width / 2;
        const centerY = baseRect.top + baseRect.height / 2;
        let deltaX = e.clientX - centerX;
        let deltaY = e.clientY - centerY;

        estampaLayer.posX += deltaX * 0.1; // Ajuste a sensibilidade
        estampaLayer.posY += deltaY * 0.1;

        renderCanvas();
    });
    
    // --- Lógica de Seleção de Ativos Adaptada ---
    function selectAsset(thumb) {
        const type = thumb.dataset.type;
        const assetInfo = { ...thumb.dataset };

        if (type === 'mockups') {
            loadImageForLayer(1, assetInfo.url); // Camada 1 é o mockup
        } else if (type === 'estampas') {
            codigoEstampaEl.textContent = assetInfo.code || "Custom";
            loadImageForLayer(0, assetInfo.url, (loadedImg) => {
                // Atualiza a régua após a imagem da estampa carregar
                const dpi = parseFloat(assetInfo.dpi) || DPI_PADRAO;
                const widthCm = (loadedImg.naturalWidth / dpi) * 2.54;
                const heightCm = (loadedImg.naturalHeight / dpi) * 2.54;
                
                state.rulerMaxCmW = Math.ceil(widthCm / 10) * 10;
                state.rulerMaxCmH = Math.ceil(heightCm / 10) * 10;
                renderRulers();
            });
        }
    }

    // --- Lógica de Exportação Adaptada ---
    document.getElementById('downloadMockupBtn').addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = 'mockup-final.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });


    // --- Funções que permanecem similares ou precisam de adaptação futura ---
    function renderRulers() {
        rulerH.innerHTML = '';
        rulerV.innerHTML = '';
        const canvasArea = document.querySelector('.canvas-area');
        if (!canvasArea) return;
        
        const maxCmW = state.rulerMaxCmW;
        const maxCmH = state.rulerMaxCmH;
        const pxPerCmW = canvasArea.offsetWidth / maxCmW;
        const pxPerCmH_ruler = canvasArea.offsetHeight / maxCmH; // Nome corrigido para não conflitar

        for (let i = 0; i <= maxCmW; i++) {
            const posH = i * pxPerCmW;
            const tickH = document.createElement('div');
            tickH.className = 'tick';
            tickH.style.left = `${posH}px`;
            if (i % 10 === 0) {
                tickH.classList.add('major');
                const label = document.createElement('span');
                label.className = 'label';
                label.textContent = i;
                label.style.left = `${posH}px`;
                rulerH.appendChild(label);
            } else if (i % 5 === 0) { tickH.classList.add('medium'); }
            else { tickH.classList.add('minor'); }
            rulerH.appendChild(tickH);
        }
        for (let i = 0; i <= maxCmH; i++) {
            const posV = i * pxPerCmH_ruler;
            const tickV = document.createElement('div');
            tickV.className = 'tick';
            tickV.style.top = `${posV}px`;
            if (i % 10 === 0) {
                tickV.classList.add('major');
                const label = document.createElement('span');
                label.className = 'label';
                label.textContent = i;
                label.style.top = `${posV}px`;
                rulerV.appendChild(label);
            } else if (i % 5 === 0) { tickV.classList.add('medium'); }
            else { tickV.classList.add('minor'); }
            rulerV.appendChild(tickV);
        }
    }

    // Funções de assets e modais (simplificadas para o exemplo)
    document.querySelector('.assets-content').addEventListener('click', (e) => {
        if (e.target.matches('.thumbnail')) selectAsset(e.target);
    });

    async function fetchAssets() {try {
            const response = await fetch(BACKEND_URL, { headers: { 'Authorization': AUTH_HEADER } });
            if (!response.ok) throw new Error('Falha ao carregar ativos');
            assetsData = await response.json();
            renderAllAssetCompartments();
        } catch (error) { console.error("Erro no fetchAssets:", error); } }

    // --- INICIALIZAÇÃO ---
    function init() {
        // Carrega a imagem inicial do mockup
        loadImageForLayer(1, state.layers[1].source, () => {
            fetchAssets();
        applyTransforms();
        renderRulers();
        });
        renderRulers();
        new ResizeObserver(() => {
            renderRulers();
            if(!state.mockupVisible) {
                resetPanZoomState();
            }
        }).observe(document.querySelector('.canvas-area'));
    }

    init();
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
